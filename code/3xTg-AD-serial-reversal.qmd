---
title: "Serial Reversal Learning in an Olfactory Discrimination Task in 3xTg-AD Mice"
author:
  - name: Kyle M Roddick
    affiliations:
      - ref: dal
  - name: Heather M Schellinck
    affiliations:
      - ref: dal
  - name: Richard E Brown
    affiliations:
      - ref: dal
    attributes:
      corresponding: true
affiliations:
  - id: dal
    name: Dalhousie University
    deparment: Psychology and Neuroscience, 
execute:
  echo: false
  warning: false
format:
    pdf:
        include-in-header: 
            text: |
                \usepackage{fancyhdr}
                \usepackage[margin=1in]{geometry}
                \usepackage[nolists, nomarkers]{endfloat}
                \setmainfont{Times New Roman}
                \linespread{1.6}
                
        include-before-body:
            text: |
                \pagestyle{fancy}
                \fancyhead[L]{Serial Reversal in 3xTg-AD Mice}
                \fancyhead[R]{\today}
                \fancyfoot[C]{\thepage}
        toc: false
        number-sections: true
        fontsize: 12pt
        template-partials: 
            - title.tex
bibliography: references.bib
csl: apa.csl
---

```{r}
#### Load libraries ----------------------------------------------------
library(here)
library(janitor)
library(rstatix)
library(tidyverse)
library(knitr)
    options(knitr.kable.NA = '')
library(kableExtra)
library(lubridate)
library(cowplot)
    
source(here("code", "format_p_values.R"))

#### Set plot colours --------------------------------------------------

col_3x <- "grey75"
col_B6 <- "grey30"

#### Read and wrangle data ---------------------------------------------

# Genotypes data

geno <- read_csv(here("data", "geno clean.csv"),
                 col_types = "cffDDdd") %>% 
    mutate(sex = case_when(
            sex == "f" ~ "Female",
            sex == "m" ~ "Male"),
        sex = as.factor(sex),
        geno = case_when(
            geno == "tg" ~ "3xTg-AD",
            geno == "wt" ~ "B6129"),
        geno = as.factor(geno),
        end = mdy(end),
        retest_date = mdy(retest_date),
        retest_days = as.numeric(retest_date - end)) %>% 
    clean_names()

# Manual data

manual_files <- list.files(here("data", "csvs"),
                           pattern = "\\.csv",
                           full.names = TRUE)

manual_data <- manual_files %>% 
    map_dfr(read_csv,
            col_types = "cccdddddl") %>% 
    clean_names() %>% 
    filter(!exclude) %>% 
    mutate(rev = rev == "yes",
           retest = str_to_lower(op) == "retest") %>% 
    rename(animal = mouse) %>% 
    select(-exclude)

# Auto data

auto_files <- list.files(here("data", "auto"),
                         pattern = "\\.csv",
                         full.names = TRUE)

auto_data <- auto_files %>% 
    map_dfr(read_csv,
            col_types = "ccddccdddddccdddddccldlld",
            comment = "#") %>% 
    clean_names() %>% 
    mutate(animal = case_when(
            animal == "1297" ~ "1927",
            TRUE ~ animal),
           op = str_extract(study_name,
                            "[:digit:]+"),
           rev = str_detect(study_name,
                            "REV"),
           retest = str_detect(study_name,
                               "RETEST")) %>% 
    group_by(animal, date, study_name, block, op, rev, retest) %>% 
    summarise(hit = sum(correct[trial_type == "P"], na.rm = TRUE),
              p_trials = sum(trial_type[!ss] == "P"),
              cr = sum(correct[trial_type == "N"], na.rm = TRUE),
              n_trials = sum(trial_type[!ss] == "N")) %>% 
    ungroup() %>% 
    select(-date, -study_name)

# Combine manual and auto data, summarize and add genotypes

dat <- bind_rows(manual_data, auto_data) %>% 
    group_by(animal, op, rev, retest) %>% 
    summarise(across(hit:n_trials,
                     ~ sum(.x))) %>% 
    mutate(errors = (p_trials + n_trials) - (hit + cr),
           op = case_when(
               op %in% 0:18 ~ as.numeric(op)
           ),
           op_n = op,
           rev = as.factor(rev),
           retest = as.factor(retest),
           op = as.factor(op)) %>% 
    left_join(geno,
              by = c("animal" = "mouse")) %>% 
    ungroup()

# # check for missing data
# dat %>% 
#     ungroup() %>% 
#     complete(animal = unique(dat$animal),
#              op = as.factor(0:18),
#              rev = as.factor(c(TRUE, FALSE))) %>% 
#     filter(!(op == 0 & rev == TRUE),
#            !(animal %in% c(1871, 1967)),
#            is.na(errors)) %>% 
#     left_join(geno,
#               by = c("animal" = "mouse")) %>% 
#     select(animal:rev, start.y) %>% 
#     View()

```

# Methods

## Subjects

```{r}
#| label: tbl-subjects
#| tbl-cap: "Number, sex, and age of mice\nof each genotype tested."

subj_table <- geno %>% 
    filter(mouse %in% dat$animal) %>% 
    group_by(geno, sex) %>% 
    summarise(mean_age = mean(days),
              range_age = str_c(format(min(days), drop0trailing = TRUE), " - ",
                                format(max(days), drop0training = TRUE)),
              n = length(days)) %>% 
    kbl(format = "latex",
        col.names = c("Genotype", "Sex", "Mean age (days)",
                        "Age range", "N"),
        digits = 2,
        booktabs = TRUE,
        linesep = "")

subj_table

save_kable(subj_table,
           here("figures", "subj_table.pdf"))

subj_n_table <- geno %>% 
    filter(mouse %in% dat$animal) %>% 
    group_by(geno) %>% 
    count()

t_test_age <- geno %>% 
    filter(mouse %in% dat$animal) %>%
    ungroup() %>% 
    t_test(days ~ geno)

age_table <- geno %>% 
    filter(mouse %in% dat$animal) %>% 
    group_by(geno) %>% 
    summarise(age_mean = mean(days),
              age_sd = sd(days))

```

Male and female 3xTg-AD (B6;129-Tg(APPSwe,tauP301L)1Lfa Psen1^tm1Mpm^/Mmjax; JAX stock #004807) and B6129SF2/J mice (JAX stock #101045) were bred at Dalhousie University from parents purchased from the Jackson Laboratory in Bar Harbour, Maine.
The 3×Tg-AD mice have three mutations, the Swedish (K670N/ M671L) mutation to amyloid precursor protein (APP), a mutation to presenilin-1 (PS1) (M146V), and a tau mutation (P301L) [@oddoTripleTransgenicModelAlzheimer2003].
Pups were weaned at 21 days of age and housed in same sex groups of 2-4 in transparent polyethylene cages (35 × 12 × 12 cm) with ad libitum food (Purina Rodent Chow #5001) and tap water.
Housing cages contained pine chip bedding and a polyvinyl chloride tube (5 cm diameter, 8 cm long) for enrichment.
The housing room was on a 12:12 h reversed light/dark cycle with lights off at 0930h.
Mice were genotyped using polymerase chain reaction by Dr. Chris Sinal (Department of Pharmacology, Dalhousie University) from ear punches taken at the time of weaning for individual identification.
There were `r dat %>% pull(animal) %>% unique() %>% length()` mice included in this study (@tbl-subjects).
All test procedures were approved by the Dalhousie Committee on Animal Care (Protocol \# 13-044).

## Apparatus

Two liquid dilution olfactometers (Knosys Olfactometers Inc.) previously described [@roddickOlfactoryDelayedMatching2014; @slotnickOlfactometryMice2005] were used.
Air was sent through a charcoal filter after which it was split into two pathways, one with clean air, and the other through a manifold which controlled the air flow through saturation bottles and into a T-junction, where clean and odorized air flows were mixed.
A final valve diverted the air flow to the exhaust, or to the odour sampling port which was open to the animal chamber.
The odour sampling port contained an infrared beam to detect nose-pokes, a reinforcement tube delivering the water reward, and a sensor that detected when the mice were licking the reinforcement tube.

## Odours

```{r}
#| label: tbl-odours
#| tbl-cap: "Odour pairs used at each stage of testing."

odours_table <- read_csv(here("data", "odour_pairs.csv")) %>% 
    kbl(format = "latex",
        booktabs = TRUE,
        linesep = "")

odours_table

save_kable(odours_table,
           here("figures", "odours_table.pdf"))
```

All odorants (@tbl-odours) were purchased from Aldrich Chemical Company Inc. (Milwaukee, WI) and diluted in heavy mineral oil.
For each mouse, the rewarded (S+) and unrewarded (S-) odours were randomly assigned during each discrimination task.

## Water restriction

Ten days prior to the start of testing, mice were individually housed and placed on water restriction.
Mice were weighed daily and given measured amounts of mash (powdered food pellets mixed with water) to maintain their weight at approximately 85% of free feeding weight.
They had *ad lib* access to food during water restriction.

## Behavioural testing

All behavioural testing was done during the dark phase of the light/dark cycle.
Behavioural testing was done in four phases: response training, odour discrimination training, odour discrimination and reversal, and a retest.

In **response training**, the mice were initially trained for 20 trials to lick the reinforcement tube  and received a water reward for simply licking the tube.
The inter-trial interval increased from 0.1 s to 12 s over the 20 trials.
During the next stage of training, a rewarded stimulus (S+) odour was introduced and the mice were required to keep their head in the odour sampling port while the final valve diverted the odour into the port.
The length of time the mice were required to keep their head in the odour sampling port increased from 0.1 s to 1.1 s over 120 trials.
This stage of training was completed when the mice performed 20 trials with the final valve on for 1.1 s.

**Odour discrimination training** involved introducing the unrewarded (S-) odour.
During this stage of training the mice were presented with a stimulus odour, either rewarded (S+), or unrewarded (S-), when they inserted their head into the odour sampling port.
When the mice were presented with the S+, they received a water reward (XX $\mu$l) for licking the reinforcement tube.
Trials were initiated by the mice poking their nose into the odour sampling port, with a minimum inter-trial interval of 4 s.
They were first presented with 20 trials of the S+ odour.
If they did not respond to at least 85% of these S+ presentations they were placed back on the response training.
They were then presented with blocks of 20 trials consisting of 10 S+ and 10 S- trials.
This continued until the mice achieved 85% correct responses on a block.

Mice were then moved to the **discrimination and reversal learning stage**, which consisted of a two odour discrimination problem using odour pair 1.
They were given blocks of 20 trials, 10 S+ and 10 S-, until they achieved 85% correct.
They were then presented with a reversal problem using odour pair 1 in which the S+ odour became the S- odour and vice-versa, and given blocks of 20 trials (10 S+ and 10 S-) until they achieved 85% correct.
This pattern of presenting a discrimination task followed by a reversal task was repeated with each of the 18 odour pairs.

One, two, or three months after finishing the reversal of odour pair 18, mice were **retested** on that reversal ti assess long term memory of that odour pair.
The mice were given blocks of 20 trials (10 S+ and 10 S-) until they achieved 85% correct.

## Statistical analysis
```{r}
sex_aov <- dat %>% 
    filter(op == 0) %>% 
    anova_test(dv = errors,
               between = c(geno, sex),
               covariate = days)
```

Data were analized using R version 4.2.2 [@rcoreteamLanguageEnvironmentStatistical2022], using the "tidyverse" [@wickhamWelcomeTidyverse2019] and "rstatix" [@kassambaraRstatixPipeFriendlyFramework2022] packages.
The number of errors made prior to reaching criterion was used as the measure of learning.
Due to the small number of male mice included, the lack of a significant sex effect, and small effect size in the number of errors made on training (*F*~(`r format(sex_aov$DFn[3], digits = 2)`,`r format(sex_aov$DFd[3], digits = 2)`)~ = `r format(sex_aov$F[3], digits = 2)`, *p* `r format.p(sex_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(sex_aov$ges[3], digits = 2)`), sexes were pooled together for analyses.
The 3xTg-AD mice (`r format(age_table$age_mean[1], digits = 2)` ± `r format(age_table$age_sd[1], digits = 2)` days) were significantly younger than the B6129 mice (`r format(age_table$age_mean[2], digits = 2)` ± `r format(age_table$age_sd[2], digits = 2)` days; *t*~`r format(t_test_age$df, digits = 2)`~ = `r format(t_test_age$statistic, digits = 2)`, *p* `r format.p(t_test_age$p)`).
Due to thos difference in the ages, ANCOVAs with age as a covariate were used to control for age differences, and age was correlated with errors made to examine age related changes in error rates.
Greenhouse-Geisser corrections were applied when Mauchly's test for sphericity detected that within-subjects factors violated sphericity.
Pearson's $\chi^2$ tests, with Yate's continuity corrections when examining the genotype effects, were run on the number of mice showing errorless learning, defined as making only zero or one errors on a discrimination task or reversal.
To assess the effects of age, Pearson's correlations were run.
Levene's tests were used to assess equality of variances between genotypes.

# Results

## Odour discrimination training

```{r}
#| label: fig-training-errors
#| fig-cap: "Number of errors made during odour discrimination training by 3xTg-AD and B6129 mice. The boxes represent the inter-quartile range (IQR), the bars in the middle of each box show the medians, the boarders of each box shows the 25th and 75th percentiles, and the whiskers extending to the furthest points within 1.5 interquartile ranges"

training_dat <- dat %>% 
    filter(op == 0)

training_ancova <- training_dat %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               covariate = days) %>% 
    get_anova_table()

training_summary <- training_dat %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(errors),
              errors_sd = sd(errors))

brks <- seq(0, 160, 10)
lbs <- ifelse(brks %% 40 == 0, brks, "")

training_dat %>% 
    ggplot(aes(x = geno,
               y = errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               alpha = .5) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Errors",
         x = "Genotype", 
         title = "Supplemental Figure 1") +
    scale_y_continuous(breaks = brks, 
                       labels = lbs) +
    scale_fill_manual(values = c(col_3x, col_B6))

ggsave(here("figures", "training_plot.pdf"),
       width = 6,
       height = 4)
```

An ANCOVA with age as a covariate was used to compare the number of errors made during the initial odour discrimination training.
All mice learned the odour discrimination, but the B6129 mice (`r format(training_summary$errors_mean[2], digits = 2)` ± `r format(training_summary$errors_sd[2], digits = 2)`) made more errors prior to reaching criterion than the 3xTg-AD mice (`r format(training_summary$errors_mean[1], digits = 2)` ± `r format(training_summary$errors_sd[1], digits = 2)`; *F*~(`r format(training_ancova$DFn[2], digits = 2)`,`r format(training_ancova$DFd[2], digits = 2)`)~ = `r format(training_ancova$F[2], digits = 2)`, *p* `r format.p(training_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(training_ancova$ges[2], digits = 2)`, @fig-training-errors).

## Discrimination learning trials

```{r}
#| label: fig-overall
#| fig-cap: "Mean number of errors (±95% CI) made by 3xTg-AD and B6129 mice on the discrimination and reversal trials for each odour pair. The difference scores (reversal errors - discriminatino errors) are indicated by the lines on each pair."

overall_dat <- dat %>% 
    filter(retest == FALSE,
           op_n > 0) %>% 
    pivot_wider(id_cols = c(animal, op, op_n, geno, days),
                names_from = rev,
                values_from = errors) %>% 
    select(animal,
           op,
           op_n,
           geno,
           days,
           disc = `FALSE`,
           rev = `TRUE`)

brks <- seq(0, 175, 25)
lbs <- ifelse(brks %% 50 == 0, brks, "")

overall_dat %>% 
    pivot_longer(c(disc, rev),
                 names_to = "condition",
                 values_to = "errors") %>% 
    group_by(op_n, geno, condition) %>% 
    mutate(x = case_when(
        condition == "disc" ~ op_n,
        condition == "rev" ~ op_n + .33),
              y = errors) %>% 
    ggplot(aes(x = x,
               y = y,
               shape = condition,
               colour = geno)) +
    stat_summary(fun.data = "mean_cl_boot") +
    geom_segment(data = overall_dat %>%
                     group_by(op, geno) %>%
                     summarise(x = mean(op_n),
                               y = mean(disc, na.rm = TRUE),
                               xend = mean(op_n) + .33,
                               yend = mean(rev, na.rm = TRUE),
                               condition = "disc"),
                 aes(x = x, y = y, 
                     xend = xend, yend = yend), 
                     colour = "black") +
    facet_grid(rows = vars(geno)) +
    theme_bw() +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_x_continuous(breaks = 1:18) +
    scale_shape_manual(values = c(16, 1),
                       labels = c("Discriminatinon trials", "Reversal trials")) +
    scale_colour_manual(values = c(col_3x, col_B6)) +
    theme(panel.grid = element_blank(),
          legend.position = c(.8, .9),
          legend.title = element_blank(),
          legend.background = element_blank()) +
    guides(shape = "legend", colour = "none") +
    labs(x = "Odour pair",
         y = "Errors")

ggsave(here("figures", "difference_scores.pdf"),
       width = 6,
       height = 4)
```

```{r}
disc_dat <- dat %>% 
    filter(retest == FALSE, 
           rev == FALSE,
           op_n > 0)

rev_dat <- dat %>% 
    filter(retest == FALSE, 
           rev == TRUE)
```

```{r}
disc_first_third_aov <- disc_dat %>% 
    filter(op_n < 7) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

disc_first_third_ph <- disc_dat %>% 
    filter(op_n < 7) %>% 
    ungroup() %>%
    tukey_hsd(errors ~ as.factor(op))

disc_second_third_aov <- disc_dat %>% 
    filter(op_n >= 7,
           op_n < 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

disc_last_third_aov <- disc_dat %>% 
    filter(op_n >= 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()
```

For each odour pair we analyzed the number of errors on the discrimination, the number of errors on the reversal, and the difference in the number of errors betweern the reversal and the discrimination.

The sequence of odour pairs (@fig-overall) was divided into thirds, and ANCOVAs, with age as the covariate, were used to analyze the number of errors on the odour discrimination trials in each third.

There were no significant effects of genotype, odour pair, nor interactions between genotype and odour pair, in the first (1 - 6), second (7 - 12) or last thirds (13 - 18) of trials (*p*'s \>= `r format(min(c(disc_first_third_aov$p, disc_second_third_aov$p, disc_last_third_aov$p), digits = 2))`; @fig-errors A).

### Near errorless learning

```{r}
#| label: fig-errorless
#| fig-cap: "Number of 3xTg-AD and B6129 mice showing errorless learning on each odour pair during A) discrimination learning, and B) reversal learning."
#| fig-height: 6

disc_1_error <- disc_dat %>% 
    filter(errors == 1)

disc_0_error <- disc_dat %>% 
    filter(errors == 0)

disc_error <- disc_dat %>% 
    filter(errors <= 1)

disc_errorless_table <- disc_error %>% 
    pull(animal) %>% 
    table()

disc_best_mouse <- disc_errorless_table %>% 
    which.max() %>% 
    attr("names")

disc_best_geno <- geno$geno[geno$mouse == disc_best_mouse]

disc_errorless_dat <- disc_dat %>% 
    mutate(errorless = errors <= 1)

disc_errorless_plot <- disc_errorless_dat %>% 
    filter(errorless) %>% 
    group_by(geno, op, op_n) %>% 
    count() %>%
    ungroup() %>% 
    complete(geno = levels(dat$geno),
             op_n = 1:18,
             fill = list(n = 0)) %>% 
    ggplot(aes(x = op_n,
               y = n,
               colour = geno)) +
    geom_point(position = position_dodge(width = .33)) +
    theme_classic() +
    scale_x_continuous(breaks  = 1:18) +
    scale_y_continuous(breaks = 0:7) +
    scale_colour_manual(values = c(col_3x, col_B6)) +
    labs(x = "Odour pair",
         y = "Number of mice\nwith 0 or 1 errors",
         tag = "A")  +
    theme(legend.title = element_blank(),
          legend.position = c(.15, .9),
          legend.background = element_blank())

rev_1_error <- rev_dat %>% 
    filter(errors == 1)

rev_0_error <- rev_dat %>% 
    filter(errors == 0)

rev_error <- rev_dat %>% 
    filter(errors <= 1)

rev_errorless_table <- rev_error %>% 
    pull(animal) %>% 
    table()

rev_best_mouse <- rev_errorless_table %>% 
    which.max() %>% 
    attr("names")

rev_best_geno <- geno$geno[geno$mouse == rev_best_mouse]

rev_errorless_dat <- rev_dat %>% 
    mutate(errorless = errors <= 1)

rev_errorless_plot <- rev_errorless_dat %>% 
    filter(errorless) %>% 
    group_by(geno, op_n) %>% 
    count() %>%
    ungroup() %>% 
    complete(geno = levels(dat$geno),
             op_n = 1:18,
             fill = list(n = 0)) %>% 
    ggplot(aes(x = op_n,
               y = n,
               colour = geno)) +
    geom_point(position = position_dodge(width = .33),
               shape = 1) +
    theme_classic() +
    labs(x = "Odour pair",
         y = "Number of mice\nwith 0 or 1 errors",
         tag = "B")  +
    scale_x_continuous(breaks = 1:18) +
    scale_y_continuous(breaks = 0:5) +
    scale_colour_manual(values = c(col_3x, col_B6)) +
    theme(legend.title = element_blank(),
          legend.position = c(.15, .9),
          legend.background = element_blank())

plot_grid(disc_errorless_plot,
          rev_errorless_plot,
          nrow = 2)

ggsave(here("figures", "errorless.pdf"),
       width = 6,
       height = 6)
```

```{r}
#| label: fig-errorless-age
#| fig-cap: "Correlation between mouse age and A) the number of instances of near errorless performance made across all 18 discrimination learning trials, B) the number of instances of near errorless performance made across all 18 reversal learning trials."
#| fig-height: 6

brks <- seq(0, 6, 1)
lbs <- ifelse(brks %% 2 == 0, brks, "")

disc_errorless_age_plot <- disc_errorless_dat %>% 
    group_by(animal, sex, geno, days) %>% 
    summarise(errorless_ops = sum(errors <= 1)) %>% 
    ggplot(aes(x = days,
               y = errorless_ops,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.85, .85)) +
    labs(x = "Age (days)",
         y = "Instances of\nErrorless Performance (n)",
         tag = "A") +
    scale_x_continuous(breaks = c(200, 400, 600, 800),
                       expand = expansion(mult = c(.05, .08))) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6))

brks <- seq(0, 5, 1)
lbs <- ifelse(brks %% 2 == 0, brks, "")

rev_errorless_age_plot <- rev_errorless_dat %>% 
    group_by(animal, sex, geno, days) %>% 
    summarise(errorless_ops = sum(errors <= 1)) %>% 
    ggplot(aes(x = days,
               y = errorless_ops,
               colour = geno)) +
    geom_point(shape = 1) +
    geom_smooth(method = "lm") +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = "none") +
    labs(x = "Age (days)",
         y = "Instances of\nErrorless Performance (n)",
         tag = "B") +
    scale_x_continuous(breaks = c(200, 400, 600, 800),
                       expand = expansion(mult = c(.05, .08))) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6))

plot_grid(disc_errorless_age_plot,
          rev_errorless_age_plot,
          ncol = 1)
    
ggsave(here("figures", "errorless_age_plot.pdf"),
       width = 6,
       height = 6)

```

```{r}

disc_errorless_chi_op <- disc_errorless_dat %>% 
    group_by(animal, op_n) %>% 
    summarize(errorless = any(errorless)) %>% 
    tabyl(errorless, op_n) %>% 
    chisq.test()

disc_errorless_chi_geno <- disc_errorless_dat %>% 
    group_by(animal, geno) %>% 
    summarize(errorless = any(errorless)) %>% 
    tabyl(errorless, geno) %>% 
    chisq.test(correct = FALSE)

disc_errorless_age_cor <- disc_errorless_dat %>% 
    group_by(animal, sex, geno, days) %>% 
    summarise(errorless_ops = sum(errors <= 1)) %>% 
    group_by(geno) %>% 
    cor_test(errorless_ops, days)

rev_errorless_age_cor <- rev_errorless_dat %>% 
    group_by(animal, sex, geno, days) %>% 
    summarise(errorless_ops = sum(errors <= 1)) %>% 
    group_by(geno) %>% 
    cor_test(errorless_ops, days)
```

There were `r disc_1_error %>% nrow()` times where mice made a single error on the initial discrimination of the odour pair, and `r disc_0_error %>% nrow()` times where a mouse made zero errors (@fig-errorless A),
with `r disc_errorless_table %>% length()` different mice learning at least one discrimination with just one or zero errors.
One mouse, a `r disc_best_geno`, had one or fewer errors on the initial discrimination of `r disc_errorless_table %>% max()` odour pairs.

The effect of odour pair was significant ($\chi^2$~`r format(disc_errorless_chi_op$parameter, digits = 2)`~ = `r format(disc_errorless_chi_op$statistic, digits = 2)`, *p* `r format.p(disc_errorless_chi_op$p.value)`), with the majority of errorless discriminations occurring on odour pairs 8 - 18 as the number of errorless odour pairs increased from `r disc_error %>% filter(op_n < 7) %>% nrow()` to `r disc_error %>% filter(op_n >= 7, op_n < 13) %>% nrow()` to `r disc_error %>% filter(op_n >= 13) %>% nrow()` in each third of the odour pairs.
The effect of genotype on errorless learning was not significant ($\chi^2$~`r format(disc_errorless_chi_geno$parameter, digits = 2)`~ = `r format(disc_errorless_chi_geno$statistic, digits = 2)`, *p* `r format.p(disc_errorless_chi_geno$p.value)`).

### Age effects

```{r}
disc_corr_test <- disc_dat %>% 
    # filter(op == 1) %>%
    group_by(animal, geno, days) %>% 
    summarize(errors = sum(errors)) %>% 
    group_by(geno) %>% 
    cor_test(errors, days)
```

There were no significant Pearson's correlations between the age of the mice and the number of errors made on discrimination learning across all odour pairs for either the B6129 (*r* = `r format(disc_corr_test$cor[2], digits = 2)`, *p* `r format.p(disc_corr_test$p[2])`), nor the 3xTg-AD (*r* = `r format(disc_corr_test$cor[1], digits = 2)`, *p* `r format.p(disc_corr_test$p[1])`) mice (@fig-age-corr A), thus there was no significant change in errors with age.

There were no significant Pearson's correlations between the age of the mice and the number of near errorless odour pairs made on discrimination learning across all odour pairs for either the B6129 (*r* = `r format(disc_errorless_age_cor$cor[2], digits = 2)`, *p* `r format.p(disc_errorless_age_cor$p[2])`), nor the 3xTg-AD (*r* = `r format(disc_errorless_age_cor$cor[1], digits = 2)`, *p* `r format.p(disc_errorless_age_cor$p[1])`) mice (@fig-errorless-age A), thus there was no significant change in near errorless learning with age.

### Total Errors on Discrimination

```{r}

total_disc_errors_dat <- disc_dat %>% 
    group_by(animal, sex, geno, days) %>% 
    summarise(disc_errors = sum(errors)) 

total_disc_errors_summary <- total_disc_errors_dat %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(disc_errors),
              errors_sd = sd(disc_errors))

total_disc_errors_ancova <- total_disc_errors_dat %>% 
    ungroup() %>% 
    anova_test(dv = disc_errors,
               between = geno,
               covariate = days)
```

An ANCOVA, with age as the covariate, found no significant effect of genotype in the total errors made per mouse during the discrimination trials (*F*~(`r format(total_disc_errors_ancova$DFn[2], digits = 2)`,`r format(total_disc_errors_ancova$DFd[2], digits = 2)`)~ = `r format(total_disc_errors_ancova$F[2], digits = 2)`, *p* `r format.p(total_disc_errors_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(total_disc_errors_ancova$ges[2], digits = 2)`; @fig-total-disc-errors), as the B6129 (`r format(total_disc_errors_summary$errors_mean[2], digits = 2)` ± `r format(total_disc_errors_summary$errors_sd[2], digits = 2)`) mice made a similar number of errors as the 3xTg-AD mice (`r format(total_disc_errors_summary$errors_mean[1], digits = 2)` ± `r format(total_disc_errors_summary$errors_sd[1], digits = 2)`). 


```{r}
#| label: fig-total-disc-errors
#| fig-cap: "Total errors made by each mouse during the 18 odour discrimination learning tests."

brks <- seq(100, 1400, 25)
lbs <- ifelse(brks %% 50 == 0, brks, "")

disc_dat %>% 
    group_by(animal, sex, geno) %>% 
    summarise(disc_errors = sum(errors)) %>% 
    ggplot(aes(x = geno,
               y = disc_errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               alpha = .5) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Total Discrimination Errors",
         x = "Genotype") +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_fill_manual(values = c(col_3x, col_B6))

ggsave(here("figures", "total_disc_errors_plot.pdf"),
       width = 6,
       height = 4)
```


## Reversal learning

```{r}

rev_first_third_aov <- rev_dat %>% 
    filter(op_n < 7) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

rev_first_third_summary <- rev_dat %>% 
    filter(op_n < 7) %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(errors, na.rm = TRUE),
              errors_sd = sd(errors, na.rm = TRUE))

rev_first_third_ph <- rev_dat %>% 
    filter(op_n < 7) %>% 
    group_by(op) %>%
    tukey_hsd(errors ~ geno)

rev_second_third_aov <- rev_dat %>% 
    filter(op_n >= 7,
           op_n < 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

rev_last_third_aov <- rev_dat %>% 
    filter(op_n >= 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

rev_last_third_aov_drop <- rev_dat %>% 
    filter(op_n >= 13,
           errors < 150) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()
    
rev_last_third_ph <- rev_dat %>% 
    filter(op_n >= 13) %>% 
    group_by(op) %>%
    tukey_hsd(errors ~ geno)
```

The sequence of reversal learning odour pairs was divided into thirds, and ANCOVAs, with age as the covariate, were used to analyze the number of errors on the reversal trials.

In the first third (1 - 6) of odour pairs in reversal learning there was a significant effect of genotype (*F*~(`r format(rev_first_third_aov$DFn[2], digits = 2)`,`r format(rev_first_third_aov$DFd[2], digits = 2)`)~ = `r format(rev_first_third_aov$F[2], digits = 2)`, *p* `r format.p(rev_first_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(rev_first_third_aov$ges[2], digits = 2)`), with the B6129 mice (`r format(rev_first_third_summary$errors_mean[2], digits = 2)` ± `r format(rev_first_third_summary$errors_sd[2], digits = 2)`) making more errors than the 3xTg-AD mice (`r format(rev_first_third_summary$errors_mean[1], digits = 2)` ± `r format(rev_first_third_summary$errors_sd[1], digits = 2)`),
but no significant effect of odour pair (*F*~(`r format(rev_first_third_aov$DFn[3], digits = 2)`,`r format(rev_first_third_aov$DFd[3], digits = 2)`)~ = `r format(rev_first_third_aov$F[3], digits = 2)`, *p* `r format.p(rev_first_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(rev_first_third_aov$ges[3], digits = 2)`), nor an interaction (*F*~(`r format(rev_first_third_aov$DFn[5], digits = 2)`,`r format(rev_first_third_aov$DFd[5], digits = 2)`)~ = `r format(rev_first_third_aov$F[5], digits = 2)`, *p* `r format.p(rev_first_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(rev_first_third_aov$ges[5], digits = 2)`; fig-errors B).

There were no significant effects of genotype or odour pair in the second third (7 - 12) of odour pairs (*p*'s \>= `r format(min(rev_second_third_aov$p), digits = 2)`).

In the last third (13 - 18) of odour pairs there was a significant effect of age (*F*~(`r format(rev_last_third_aov$DFn[1], digits = 2)`,`r format(rev_last_third_aov$DFd[1], digits = 2)`)~ = `r format(rev_last_third_aov$F[1], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[1], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[1], digits = 2)`) and an interaction between age and odour pair (*F*~(`r format(rev_last_third_aov$DFn[4], digits = 2)`,`r format(rev_last_third_aov$DFd[4], digits = 2)`)~ = `r format(rev_last_third_aov$F[4], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[4], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[4], digits = 2)`), but no main effects of genotype (*F*~(`r format(rev_last_third_aov$DFn[2], digits = 2)`,`r format(rev_last_third_aov$DFd[2], digits = 2)`)~ = `r format(rev_last_third_aov$F[2], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[2], digits = 2)`), odour pair (*F*~(`r format(rev_last_third_aov$DFn[3], digits = 2)`,`r format(rev_last_third_aov$DFd[3], digits = 2)`)~ = `r format(rev_last_third_aov$F[3], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[3], digits = 2)`), nor an interaction between genotype and odour pair (*F*~(`r format(rev_last_third_aov$DFn[5], digits = 2)`,`r format(rev_last_third_aov$DFd[5], digits = 2)`)~ = `r format(rev_last_third_aov$F[5], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[5], digits = 2)`).
The significant effects involving age indicate that age does not significantly adjust the effects of genotype and odour pair on the ANCOVA.
However, these effects were driven by one female B6129 mouse who made 231 errors on the reversal of odour pair 17.
Removing that one mouse caused both effects to become non-significant (*p*s > `r format(min(rev_last_third_aov_drop$p, digits = 2))`).

### Near errorless learning

```{r}
rev_errorless_chi_op <- rev_errorless_dat %>% 
    group_by(animal, op_n) %>% 
    summarize(errorless = any(errorless)) %>% 
    tabyl(errorless, op_n) %>% 
    chisq.test()

rev_errorless_chi_geno <- rev_errorless_dat %>% 
    group_by(animal, geno) %>% 
    summarize(errorless = any(errorless)) %>% 
    tabyl(errorless, geno) %>% 
    chisq.test(correct = FALSE)
```

There were `r rev_1_error %>% nrow()` instances of mice making a single error on the reversal of the odour pair, and `r rev_0_error %>% nrow()` instances of a mouse making zero errors (@fig-errorless B),
with `r rev_errorless_table %>% length()` mice learning at least one reversal with just one or zero errors.
One mouse, a `r rev_best_geno`, had one or fewer errors on the reversal learninf of `r rev_errorless_table %>% max()` odour pairs.

The effect of odour pair was significant ($\chi^2$~`r format(rev_errorless_chi_op$parameter, digits = 2)`~ = `r format(rev_errorless_chi_op$statistic, digits = 2)`, *p* `r format.p(rev_errorless_chi_op$p.value)`), with the majority of errorless discriminations occuring on odour pairs 8 - 18 as the number of errorless odour pairs increased from `r rev_error %>% filter(op_n < 7) %>% nrow()` to `r rev_error %>% filter(op_n >= 7, op_n < 13) %>% nrow()` and `r rev_error %>% filter(op_n >= 13) %>% nrow()` in each third of the odour pairs.
The effect of genotype was significant ($\chi^2$~`r format(rev_errorless_chi_geno$parameter, digits = 2)`~ = `r format(rev_errorless_chi_geno$statistic, digits = 2)`, *p* `r format.p(rev_errorless_chi_geno$p.value)`), with more 3xTg-AD mice having errorless learning than the B6129 mice.

### Age effects

```{r}
rev_corr_test <- rev_dat %>% 
    # filter(op == 1) %>%
    group_by(animal, geno, days) %>% 
    summarize(errors = sum(errors)) %>% 
    group_by(geno) %>% 
    cor_test(errors, days)
```

Pearson's correlations between the age of the mice and the number of errors made across all reversal learning were not significant for either the B6129 (*r* = `r format(rev_corr_test$cor[2], digits = 2)`, *p* `r format.p(rev_corr_test$p[2])`), nor the 3xTg-AD (*r* = `r format(rev_corr_test$cor[1], digits = 2)`, *p* `r format.p(rev_corr_test$p[1])`) mice (@fig-age-corr B).

There were no significant Pearson's correlations between the age of the mice and the number of near errorless odour pairs made on reversal learning across all odour pairs for either the 3xTg-AD mice (*r* = `r format(rev_errorless_age_cor$cor[1], digits = 2)`, *p* `r format.p(rev_errorless_age_cor$p[1])`), but there was for the B6129 (*r* = `r format(rev_errorless_age_cor$cor[2], digits = 2)`, *p* `r format.p(rev_errorless_age_cor$p[2])`) mice (@fig-errorless-age B), thus there was a significant change in near errorless learning with age for the B6129 mice, bit not the 3xTg-AD mice.

### Total Errors on Reversal

```{r}

total_rev_errors_dat <- rev_dat %>% 
    group_by(animal, sex, geno, days) %>% 
    summarise(rev_errors = sum(errors)) 

total_rev_errors_summary <- total_rev_errors_dat %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(rev_errors),
              errors_sd = sd(rev_errors))

total_rev_errors_ancova <- total_rev_errors_dat %>% 
    ungroup() %>% 
    anova_test(dv = rev_errors,
               between = geno,
               covariate = days)
```

An ANCOVA, with age as the covariate, found a significant effect of genotype in the total errors made per mouse during the reversal trials (*F*~(`r format(total_rev_errors_ancova$DFn[2], digits = 2)`,`r format(total_rev_errors_ancova$DFd[2], digits = 2)`)~ = `r format(total_rev_errors_ancova$F[2], digits = 2)`, *p* `r format.p(total_rev_errors_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(total_rev_errors_ancova$ges[2], digits = 2)`; @fig-total-rev-errors), as the B6129 (`r format(total_rev_errors_summary$errors_mean[2], digits = 2)` ± `r format(total_rev_errors_summary$errors_sd[2], digits = 2)`) mice made a more errors than the 3xTg-AD mice (`r format(total_rev_errors_summary$errors_mean[1], digits = 2)` ± `r format(total_rev_errors_summary$errors_sd[1], digits = 2)`). 

```{r}
#| label: fig-total-rev-errors
#| fig-cap: "Total errors made by each mouse during the 18 odour reversal learning tests."

brks <- seq(100, 900, 50)
lbs <- ifelse(brks %% 100 == 0, brks, "")

rev_dat %>% 
    group_by(animal, sex, geno) %>% 
    summarise(disc_errors = sum(errors)) %>% 
    ggplot(aes(x = geno,
               y = disc_errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               alpha = .5) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Total Reversal Errors",
         x = "Genotype") +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_fill_manual(values = c(col_3x, col_B6))

ggsave(here("figures", "total_rev_errors_plot.pdf"),
       width = 6,
       height = 4)
```

## Difference scores in errors between the discrimination and reversal learning

```{r}
overall_diffs <- overall_dat %>% 
    mutate(diff_score = rev - disc,
           diff_pro = rev / disc)

overall_diffs_summary <- overall_diffs %>% 
    mutate(bin = case_when(
        op_n < 7 ~ 1,
        op_n >= 7 & op_n < 13 ~ 2,
        op_n >= 13 ~ 3
    )) %>% 
    group_by(bin, geno) %>% 
    summarise(across(starts_with("diff"),
                     .fns = list(mean = ~ mean(.x, na.rm = TRUE),
                                 sd = ~ sd(.x, na.rm = TRUE)),
                     .names = "{.col}_{.fn}"))

first_third_aov <- overall_diffs %>% 
    filter(op_n < 7,
           !is.na(diff_score)) %>% 
    ungroup() %>% 
    anova_test(dv = diff_score,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

first_third_ph <- overall_diffs %>% 
    filter(op_n < 7,
           !is.na(diff_score)) %>% 
    group_by(op) %>% 
    tukey_hsd(diff_score ~ geno)

second_third_aov <- overall_diffs %>% 
    filter(op_n >= 7,
           op_n < 13,
           !is.na(diff_score)) %>% 
    ungroup() %>% 
    anova_test(dv = diff_score,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

last_third_aov <- overall_diffs %>% 
    filter(op_n > 12,
           !is.na(diff_score)) %>% 
    ungroup() %>% 
    anova_test(dv = diff_score,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()
```

ANCOVAs, with age as the covariate, were conducted to examine the differences between the errors on the discrimination and reversal trials on odour pairs in each third (@fig-overall).

In the first third of odour pairs (1 - 6), there were significant effects of genotype (*F*~(`r format(first_third_aov$DFn[2], digits = 2)`,`r format(first_third_aov$DFd[2], digits = 2)`)~ = `r format(first_third_aov$F[2], digits = 2)`, *p* `r format.p(first_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(first_third_aov$ges[2], digits = 2)`), with the B6129 mice (`r format(overall_diffs_summary$diff_score_mean[2], digits = 2)` ± `r format(overall_diffs_summary$diff_score_sd[2], digits = 2)`) having greater differences scores than the 3xTg-AD mice (`r format(overall_diffs_summary$diff_score_mean[1], digits = 2)` ± `r format(overall_diffs_summary$diff_score_sd[1], digits = 2)`).
There was no significant effect of odour pair (*F*~(`r format(first_third_aov$DFn[3], digits = 2)`,`r format(first_third_aov$DFd[3], digits = 2)`)~ = `r format(first_third_aov$F[3], digits = 2)`, *p* `r format.p(first_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(first_third_aov$ges[3], digits = 2)`), nor a significant interaction (*F*~(`r format(first_third_aov$DFn[5], digits = 2)`,`r format(first_third_aov$DFd[5], digits = 2)`)~ = `r format(first_third_aov$F[5], digits = 2)`, *p* `r format.p(first_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(first_third_aov$ges[5], digits = 2)`).

On the second third of odour pairs (7 - 12) there were no significant genotype or odour pair effects (*p*'s \>= `r format(min(second_third_aov$p), digits = 2)`).

On the last third of odour pairs (13 - 18) there was a significant effect of age (*F*~(`r format(last_third_aov$DFn[1], digits = 2)`,`r format(last_third_aov$DFd[1], digits = 2)`)~ = `r format(last_third_aov$F[1], digits = 2)`, *p* `r format.p(last_third_aov$p[1], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[1], digits = 2)`) and a significant interaction between age and odour pair (*F*~(`r format(last_third_aov$DFn[4], digits = 2)`,`r format(last_third_aov$DFd[4], digits = 2)`)~ = `r format(last_third_aov$F[4], digits = 2)`, *p* `r format.p(last_third_aov$p[4], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[4], digits = 2)`), but no significant effects of genotype (*F*~(`r format(last_third_aov$DFn[2], digits = 2)`,`r format(last_third_aov$DFd[2], digits = 2)`)~ = `r format(last_third_aov$F[2], digits = 2)`, *p* `r format.p(last_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[2], digits = 2)`), odour pair (*F*~(`r format(last_third_aov$DFn[3], digits = 2)`,`r format(last_third_aov$DFd[3], digits = 2)`)~ = `r format(last_third_aov$F[3], digits = 2)`, *p* `r format.p(last_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[3], digits = 2)`), nor an interaction between genotype and odour pair (*F*~(`r format(last_third_aov$DFn[5], digits = 2)`,`r format(last_third_aov$DFd[5], digits = 2)`)~ = `r format(last_third_aov$F[5], digits = 2)`, *p* `r format.p(last_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[5], digits = 2)`).
The significant effects involving age indicate that age does not significantly adjust the effects of genotype and odour pair in the ANCOVA.

### Age Effects

```{r}
dif_corr_test <- overall_diffs %>% 
    group_by(geno) %>% 
    cor_test(diff_score, days)
```

Pearson's correlations between the age of the mice and the difference scores were not significant for either the B6129 (*r* = `r format(dif_corr_test$cor[2], digits = 2)`, *p* `r format.p(dif_corr_test$p[2])`), nor the 3xTg-AD (*r* = `r format(dif_corr_test$cor[1], digits = 2)`, *p* `r format.p(dif_corr_test$p[1])`) mice (@fig-age-diff-corr).

```{r}
#| label: fig-age-diff-corr
#| fig-cap: "Correlation between mouse age and the difference scores across all odour pairs."
#| fig-height: 8

brks <- seq(-200, 450, 50)
lbs <- ifelse(brks %% 100 == 0, brks, "")

overall_diffs %>% 
    ggplot(aes(x = days,
               y = diff_score,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.85, .85)) +
    labs(x = "Age (days)",
         y = "Difference Scores") +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_x_continuous(breaks = c(200, 400, 600, 800),
                       expand = expansion(mult = c(.05, .08))) +
    scale_colour_manual(values = c(col_3x, col_B6))

ggsave(here("figures", "age_diff_corr.pdf"),
       width = 6,
       height = 4)

```

## Total errors made on all discriminations and reversals

```{r}

total_errors_dat <- dat %>% 
    filter(retest == FALSE,
           op_n > 0) %>% 
    group_by(animal, geno, days) %>% 
    summarise(total_errors = sum(errors))

total_errors_summary <- total_errors_dat %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(total_errors),
              errors_sd = sd(total_errors))

total_errors_ancova <- total_errors_dat %>% 
    ungroup() %>% 
    anova_test(dv = total_errors,
               between = geno,
               covariate = days)
```

An ANCOVA, with age as the covariate, found a significant effect of genotype in the total errors made per mouse during the discrimination and reversal trials (*F*~(`r format(total_errors_ancova$DFn[2], digits = 2)`,`r format(total_errors_ancova$DFd[2], digits = 2)`)~ = `r format(total_errors_ancova$F[2], digits = 2)`, *p* `r format.p(total_errors_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(total_errors_ancova$ges[2], digits = 2)`; @fig-total-errors), as the B6129 (`r format(total_errors_summary$errors_mean[2], digits = 2)` ± `r format(total_errors_summary$errors_sd[2], digits = 2)`) mice made more errors than the 3xTg-AD mice (`r format(total_errors_summary$errors_mean[1], digits = 2)` ± `r format(total_errors_summary$errors_sd[1], digits = 2)`). 

```{r}
#| label: fig-total-errors
#| fig-cap: "Total errors made by each mouse during the 18 odour discrimination and reversal learning tests."


brks <- seq(200, 1200, 50)
lbs <- ifelse(brks %% 200 == 0, brks, "")

total_errors_dat %>% 
    ggplot(aes(x = geno,
               y = total_errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               alpha = .5) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Total Errors",
         x = "Genotype") +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_fill_manual(values = c(col_3x, col_B6))

ggsave(here("figures", "total_errors_plot.pdf"),
       width = 6,
       height = 4)
```

### Age effects

```{r}
total_errors_corr_test <- total_errors_dat %>% 
    group_by(geno) %>% 
    cor_test(total_errors, days)
```

Pearson correlations showed no significant relationship between the age of the mice and the total number of errors made per mouse for either the B6129 (*r* = `r format(total_errors_corr_test$cor[2], digits = 2)`, *p* `r format.p(total_errors_corr_test$p[2])`), nor the 3xTg-AD (*r* = `r format(total_errors_corr_test$cor[1], digits = 2)`, *p* `r format.p(total_errors_corr_test$p[1])`) mice (@fig-age-corr C).

## Retest

```{r}
retest_dat <- dat %>% 
    filter(retest == TRUE)

retest_date_t_test <- geno %>% 
    filter(mouse %in% retest_dat$animal) %>%
    t_test(retest_days ~ geno)

retest_summary <- geno %>% 
    filter(mouse %in% retest_dat$animal) %>%
    group_by(geno) %>% 
    summarise(days_mean = mean(retest_days, na.rm = TRUE),
            days_sd = sd(retest_days, na.rm = TRUE))

retest_table <- retest_dat %>% 
    group_by(geno) %>% 
    count()
```

Because 3xTg-AD mice have a shorter lifespan than B6129 mice [@raeProblemGenotypeSex2015], fewer 3xTg-AD mice (`r retest_table$n[1]` / `r subj_n_table$n[1]`) survived to be given the retest than the B6129 mice (`r retest_table$n[2]` / `r subj_n_table$n[2]`).

There was no significant difference in the number of days between the last reversal task and the retest for the B6129 (`r format(retest_summary$days_mean[2], digits = 2)` ± `r format(retest_summary$days_sd[2], digits = 2)`) and 3xTg-AD mice (`r format(retest_summary$days_mean[1], digits = 2)` ± `r format(retest_summary$days_sd[1], digits = 2)`; *t*~`r format(retest_date_t_test$df, digits = 2)`~ = `r format(retest_date_t_test$statistic, digits = 2)`, *p* `r format.p(retest_date_t_test$p)`).

```{r}
retest_ancova <- retest_dat %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               covariate = days)
```

An ANCOVA, with age as the covariate, found no significant effect of genotype on the number of errors made during the retest (*F*~(`r format(retest_ancova$DFn[2], digits = 2)`,`r format(retest_ancova$DFd[2], digits = 2)`)~ = `r format(retest_ancova$F[2], digits = 2)`, *p* `r format.p(retest_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(retest_ancova$ges[2], digits = 2)`; @fig-retest-errors)

```{r}
retest_vs_18_t_test <- retest_dat %>% 
    left_join(disc_dat %>% 
                  filter(op == 18) %>% 
                  select(animal, 
                         errors_18 = errors)) %>% 
    pivot_longer(cols = c(errors, errors_18),
                 names_to = "test",
                 values_to = "errors") %>% 
    group_by(geno) %>%
    t_test(errors ~ test,
           paired = TRUE)

retest_vs_18_summary <- retest_dat %>% 
    left_join(disc_dat %>% 
                  filter(op == 18) %>% 
                  select(animal, 
                         errors_18 = errors)) %>% 
    pivot_longer(cols = c(errors, errors_18),
                 names_to = "test",
                 values_to = "errors") %>%
    group_by(test, geno) %>% 
    summarise(errors_mean = mean(errors),
              errors_sd = sd(errors))
```

A paired t-test showed that the mean number of errors made during the retest (3xTg-AD: `r format(retest_vs_18_summary$errors_mean[1], digits = 2)` ± `r format(retest_vs_18_summary$errors_sd[1], digits = 2)`; B6129: `r format(retest_vs_18_summary$errors_mean[2], digits = 2)` ± `r format(retest_vs_18_summary$errors_sd[2], digits = 2)`) was significantly higher than the number of errors made on the final odour discrimination (3xTg-AD: `r format(retest_vs_18_summary$errors_mean[3], digits = 2)` ± `r format(retest_vs_18_summary$errors_sd[3], digits = 2)`; B6129:  `r format(retest_vs_18_summary$errors_mean[4], digits = 2)` ± `r format(retest_vs_18_summary$errors_sd[4], digits = 2)`) for both genotypes ( 3xTg-AD: *t*~`r format(retest_vs_18_t_test$df[1], digits = 2)`~ = `r format(retest_vs_18_t_test$statistic[1], digits = 2)`, *p* `r format.p(retest_vs_18_t_test$p[1])`; B6129: *t*~`r format(retest_vs_18_t_test$df[2], digits = 2)`~ = `r format(retest_vs_18_t_test$statistic[2], digits = 2)`, *p* `r format.p(retest_vs_18_t_test$p[2])`; @fig-retest-errors).

```{r}
#| label: fig-retest-errors
#| fig-cap: "Total errors made during the reversal of odour pair 18 and the retest by the 3xTg-AD and B6129 mice."

brks <- seq(0, 120, 10)
lbs <- ifelse(brks %% 20 == 0, brks, "")

retest_dat %>% 
    left_join(disc_dat %>% 
                  filter(op == 18) %>% 
                  select(animal, 
                         errors_18 = errors)) %>% 
    pivot_longer(cols = c(errors, errors_18),
                 names_to = "test",
                 values_to = "errors") %>% 
    mutate(test = as.factor(test) %>% fct_rev()) %>% 
    ggplot(aes(x = test,
               y = errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA,
                 position = "dodge") +
    geom_dotplot(aes(x = test,
                     y = errors,
                     fill = geno),
               position = position_dodge(.75),
               binaxis = "y",
               stackdir = "center",
               binpositions = "all",
               alpha = .5) +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.15, .85)) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_x_discrete(labels = c("Reversal 18", "Retest")) +
    scale_fill_manual(values = c(col_3x, col_B6)) +
    labs(y = "Errors",
         x = "")

ggsave(here("figures", "retest_plot.pdf"),
       width = 6,
       height = 4)
```

### Age effects

```{r}
retest_corr_test <- retest_dat %>% 
    group_by(geno) %>% 
    cor_test(errors, days) %>% 
    add_significance()
```

Pearson correlations showed no significant relationship between the age of the mice and the number of errors made on the retest for the B6129 mice (*r* = `r format(retest_corr_test$cor[2], digits = 2)`, *p* `r format.p(retest_corr_test$p[2])`), but for the 3xTg-AD mice there was a significant decrease with age (*r* = `r format(retest_corr_test$cor[1], digits = 2)`, *p* `r format.p(retest_corr_test$p[1])`; @fig-retest-corrs A).

### Time from last test effect

```{r}
retest_days_corr_test <- retest_dat %>% 
    group_by(geno) %>%
    cor_test(errors, retest_days)

retest_delay_aov <- retest_dat %>% 
    mutate(delay = case_when(
        retest_days < 45 ~ 1,
        retest_days > 45 & retest_days < 75 ~ 2,
        retest_days > 75 ~ 3
    ) %>% 
        as.factor()) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between =  c(geno, delay),
               covariate = days)
```

Although all mice showed an increase in the number of errors, Pearson correlations showed a significant, positive correlation for the B6129 mice on the number of errors made on the retest to the days since the final reversal (*r* = `r format(retest_days_corr_test$cor[2], digits = 2)`, *p* `r format.p(retest_days_corr_test$p[2])`), but not for the 3xTg-AD mice (*r* = `r format(retest_days_corr_test$cor[1], digits = 2)`, *p* `r format.p(retest_days_corr_test$p[1])`; @fig-retest-corrs B).

However, an ANCOVA showed no genotype or time effects.
The time since last reversal was binned into 30, 60, and 90 day groups.
There were no significant genotype or time until retest effects (*p*'s \>= `r format(min(retest_delay_aov$p), digits = 2)`).

```{r}
#| label: fig-errors
#| fig-cap: "Errors (±95% CI) made by the mice at on each odour pair during A) the initial discrimination learning and B) the reversal learning of each odour pair."
#| fig-height: 6

brks <- seq(0, 50, 5)
lbs <- ifelse(brks %% 10 == 0, brks, "")

disc_plot <- disc_dat %>% 
    ggplot(aes(x = op_n,
               y = errors,
               colour = geno)) +
    # geom_point(alpha = .2,
    #            shape = 20) + 
    stat_summary(fun.data = "mean_cl_boot",
                 position = position_dodge(width = .33)) +
    # geom_smooth(se = FALSE) +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.9, .9)) +
    scale_x_continuous(breaks = 1:18) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6)) +
    labs(x = "Odour pair",
         y = "Errors",
         tag = "A")

brks <- seq(0, 200, 25)
lbs <- ifelse(brks %% 50 == 0, brks, "")

rev_plot <- rev_dat %>% 
    ggplot(aes(x = op_n,
               y = errors,
               colour = geno)) +
    # geom_point(alpha = .2,
    #            shape = 20) + 
    stat_summary(fun.data = "mean_cl_boot",
                 position = position_dodge(width = .33),
                 shape = 1) +
    # geom_smooth(se = FALSE) +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.9, .9)) +
    scale_x_continuous(breaks = 1:18) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6)) +
    labs(x = "Odour pair",
         y = "Errors",
         tag = "B")

plot_grid(disc_plot,
          rev_plot,
          nrow = 2)

ggsave(here("figures", "errors_plot.pdf"),
       width = 6,
       height = 6)
    
```

```{r}
#| label: fig-age-corr
#| fig-cap: "Correlation between mouse age and A) the number of errors made across all 18 discrimination learning trials, B) the the number of errors made across all 18 reversal learning trials, and C) the total number of errors made."
#| fig-height: 8

brks <- seq(50, 400, 25)
lbs <- ifelse(brks %% 100 == 0, brks, "")

disc_age_plot <- disc_dat %>% 
    group_by(animal, geno, days) %>% 
    summarize(errors = sum(errors)) %>% 
    # filter(op == 1) %>% 
    ggplot(aes(x = days,
               y = errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.85, .85)) +
    labs(x = "Age (days)",
         y = "Errors",
         tag = "A") +
    scale_x_continuous(breaks = c(200, 400, 600, 800),
                       expand = expansion(mult = c(.05, .08))) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6))

brks <- seq(0, 900, 50)
lbs <- ifelse(brks %% 250 == 0, brks, "")

rev_age_plot <- rev_dat %>% 
    # filter(op == 1) %>%
    group_by(animal, geno, days) %>% 
    summarize(errors = sum(errors)) %>% 
    ggplot(aes(x = days,
               y = errors,
               colour = geno)) +
    geom_point(shape = 1) +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = "none") +
    labs(x = "Age (days)",
         y = "Errors",
         tag = "B") +
    scale_x_continuous(breaks = c(200, 400, 600, 800),
                       expand = expansion(mult = c(.05, .08))) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6))

brks <- seq(200, 1100, 100)
lbs <- ifelse(brks %% 300 == 0, brks, "")

total_errors_age_plot <- total_errors_dat %>% 
    ggplot(aes(x = days,
               y = total_errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = "none") +
    labs(x = "Age (days)",
         y = "Total errors",
         tag = "C") +
    scale_x_continuous(breaks = c(200, 400, 600, 800),
                       expand = expansion(mult = c(.05, .08))) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6))

plot_grid(disc_age_plot,
          rev_age_plot,
          # total_errors_age_plot,
          nrow = 2)

ggsave(here("figures", "corr_age.pdf"),
       width = 6,
       height = 8)
```

```{r}
#| label: fig-retest-corrs
#| fig-cap: "Correlation between age of the 3xTg-AD and B6129 mice and the number of errors made on the retest."
#| fig-height: 6

# retest_errors_cor_plot <- retest_dat %>% 
#     ggplot(aes(x = days,
#                y = errors,
#                colour = geno)) +
#     geom_point() +
#     geom_smooth(method = "lm") + 
#     theme_classic() +
#     theme(legend.title = element_blank(),
#           legend.position = c(.85, .85)) +
#     labs(x = "Age (days)",
#          y = "Total errors",
#          tag = "A") +
#     scale_colour_manual(values = c(col_3x, col_B6))

brks <- seq(0, 120, 10)
lbs <- ifelse(brks %% 20 == 0, brks, "")

retest_delay_cor_plot <- retest_dat %>% 
    ggplot(aes(x = retest_days,
               y = errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.1, .9)) +
    scale_x_continuous(breaks = c(30, 60, 90)) +
    scale_y_continuous(breaks = brks,
                       labels = lbs) +
    scale_colour_manual(values = c(col_3x, col_B6)) +
    labs(x = "Days since last reversal",
         y = "Total errors")

# plot_grid(retest_errors_cor_plot,
#           retest_delay_cor_plot,
#           nrow = 2)

retest_delay_cor_plot

ggsave(here("figures", "retest_corrs.pdf"),
       width = 6,
       height = 6)
```

## Individual Differences

```{r}

levene_disc <- disc_dat %>% 
    group_by(animal, geno) %>% 
    summarise(total_errors = sum(errors)) %>% 
    ungroup() %>% 
    levene_test(total_errors ~ geno)

levene_rev <- rev_dat %>% 
    group_by(animal, geno) %>% 
    summarise(total_errors = sum(errors)) %>% 
    ungroup() %>% 
    levene_test(total_errors ~ geno)

levene_total_errors <- total_errors_dat %>% 
    ungroup() %>% 
    levene_test(total_errors ~ geno)

total_errors_table <- total_errors_dat %>% 
    group_by(geno) %>% 
    summarise(min = min(total_errors),
              max = max(total_errors)) %>% 
    mutate(diff = max - min)
```

Levene's tests were run to determine if there were differences in variation between the two genotypes.
The variances did not differ between genotypes on the total errors made during discrimination trials (*W*~(`r format(levene_disc$df1, digits = 2)`,`r format(levene_disc$df2, digits = 2)`)~ = `r format(levene_disc$statistic, digits = 2)`, *p* `r format.p(levene_disc$p)`),
reversal trials (*W*~(`r format(levene_rev$df1, digits = 2)`,`r format(levene_rev$df2, digits = 2)`)~ = `r format(levene_rev$statistic, digits = 2)`, *p* `r format.p(levene_rev$p)`),
nor on the total number of errors made (*W*~(`r format(levene_total_errors$df1, digits = 2)`,`r format(levene_total_errors$df2, digits = 2)`)~ = `r format(levene_total_errors$statistic, digits = 2)`, *p* `r format.p(levene_total_errors$p)`).
The 3xTg-AD mice (`r total_errors_table$diff[total_errors_table$geno == "3xTg-AD"]`) and B6129 mice (`r total_errors_table$diff[total_errors_table$geno == "B6129"]`) had similar ranges between the best (3xTg-AD = `r total_errors_table$min[total_errors_table$geno == "3xTg-AD"]`; B6129 = `r total_errors_table$min[total_errors_table$geno == "B6129"]`) and worst (3xTg-AD = `r total_errors_table$max[total_errors_table$geno == "3xTg-AD"]`; B6129 = `r total_errors_table$max[total_errors_table$geno == "B6129"]`) performing mice in terms of total errors made.

# References
