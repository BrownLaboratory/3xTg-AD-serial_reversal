---
title: "Serial Reversal in 3xTg-AD Mice"
author:
  - name: Kyle M Roddick
    affiliations:
      - ref: dal
  - name: Heather M Schellinck
    affiliations:
      - ref: dal
  - name: Richard E Brown
    affiliations:
      - ref: dal
    attributes:
      corresponding: true
affiliations:
  - id: dal
    name: Dalhousie University
    deparment: Psychology and Neuroscience, 

execute:
  echo: false
  warning: false
format:
    pdf:
        include-in-header: 
            text: |
                \usepackage{fancyhdr}
                \usepackage[margin=1in]{geometry}
                \setmainfont{Times New Roman}
                \linespread{1.6}
                
        include-before-body:
            text: |
                \pagestyle{fancy}
                \fancyhead[L]{Serial Reversal in 3xTg-AD Mice}
                \fancyhead[R]{\today}
                \fancyfoot[C]{\thepage}
        toc: false
        number-sections: true
        bibliography: bibliography.json
        csl: apa.csl
template-partials:
  - title.tex
---

```{r}
#### Load libraries ----------------------------------------------------
library(here)
library(janitor)
library(rstatix)
library(tidyverse)
library(knitr)
    options(knitr.kable.NA = '')
library(kableExtra)
library(lubridate)
    
source(here("code", "format_p_values.R"))

#### Read and wrangle data ---------------------------------------------

# Genotypes data

geno <- read_csv(here("data", "geno clean.csv"),
                 col_types = "cffDDdd") %>% 
    mutate(sex = case_when(
            sex == "f" ~ "Female",
            sex == "m" ~ "Male"),
        sex = as.factor(sex),
        geno = case_when(
            geno == "tg" ~ "3xTg-AD",
            geno == "wt" ~ "B6129"),
        geno = as.factor(geno),
        end = mdy(end),
        retest_date = mdy(retest_date),
        retest_days = as.numeric(retest_date - end)) %>% 
    clean_names()

# Manual data

manual_files <- list.files(here("data", "csvs"),
                           pattern = "\\.csv",
                           full.names = TRUE)

manual_data <- manual_files %>% 
    map_dfr(read_csv,
            col_types = "cccdddddl") %>% 
    clean_names() %>% 
    filter(!exclude) %>% 
    mutate(rev = rev == "yes",
           retest = str_to_lower(op) == "retest") %>% 
    rename(animal = mouse) %>% 
    select(-exclude)

# Auto data

auto_files <- list.files(here("data", "auto"),
                         pattern = "\\.csv",
                         full.names = TRUE)

auto_data <- auto_files %>% 
    map_dfr(read_csv,
            col_types = "ccddccdddddccdddddccldlld",
            comment = "#") %>% 
    clean_names() %>% 
    mutate(animal = case_when(
            animal == "1297" ~ "1927",
            TRUE ~ animal),
           op = str_extract(study_name,
                            "[:digit:]+"),
           rev = str_detect(study_name,
                            "REV"),
           retest = str_detect(study_name,
                               "RETEST")) %>% 
    group_by(animal, date, study_name, block, op, rev, retest) %>% 
    summarise(hit = sum(correct[trial_type == "P"], na.rm = TRUE),
              p_trials = sum(trial_type[!ss] == "P"),
              cr = sum(correct[trial_type == "N"], na.rm = TRUE),
              n_trials = sum(trial_type[!ss] == "N")) %>% 
    ungroup() %>% 
    select(-date, -study_name)

# Combine manual and auto data, summarize and add genotypes

dat <- bind_rows(manual_data, auto_data) %>% 
    group_by(animal, op, rev, retest) %>% 
    summarise(across(hit:n_trials,
                     ~ sum(.x))) %>% 
    mutate(errors = (p_trials + n_trials) - (hit + cr),
           op = case_when(
               op %in% 0:18 ~ as.numeric(op)
           ),
           op_n = op,
           rev = as.factor(rev),
           retest = as.factor(retest),
           op = as.factor(op)) %>% 
    left_join(geno,
              by = c("animal" = "mouse")) %>% 
    ungroup()

# # check for missing data
# dat %>% 
#     ungroup() %>% 
#     complete(animal = unique(dat$animal),
#              op = as.factor(0:18),
#              rev = as.factor(c(TRUE, FALSE))) %>% 
#     filter(!(op == 0 & rev == TRUE),
#            !(animal %in% c(1871, 1967)),
#            is.na(errors)) %>% 
#     left_join(geno,
#               by = c("animal" = "mouse")) %>% 
#     select(animal:rev, start.y) %>% 
#     View()

```

# Methods

## Subjects

```{r}
#| label: tbl-subjects
#| tbl-cap: "Demographics of mice tested."

subj_table <- geno %>% 
    filter(mouse %in% dat$animal) %>% 
    group_by(geno, sex) %>% 
    summarise(mean_age = mean(days),
              range_age = str_c(format(min(days), drop0trailing = TRUE), " - ",
                                format(max(days), drop0training = TRUE)),
              n = length(days)) %>% 
    kbl(format = "latex",
        col.names = c("Genotype", "Sex", "Mean age (days)",
                        "Age range", "N"),
        digits = 2,
        booktabs = TRUE,
        linesep = "")

subj_table

save_kable(subj_table,
           here("figures", "subj_table.pdf"))

subj_n_table <- geno %>% 
    filter(mouse %in% dat$animal) %>% 
    group_by(geno) %>% 
    count()

t_test_age <- geno %>% 
    filter(mouse %in% dat$animal) %>%
    ungroup() %>% 
    t_test(days ~ geno)

age_table <- geno %>% 
    filter(mouse %in% dat$animal) %>% 
    group_by(geno) %>% 
    summarise(age_mean = mean(days),
              age_sd = sd(days))

```
Male and female 3xTg-AD mice (B6;129-Tg(APPSwe,tauP301L)1Lfa Psen1^tm1Mpm^/Mmjax; JAX stock #004807) and B6129SF2/J mice (JAX stock #101045) were tested in this study. 
The mice were bred at Dalhousie University from parents purchased from the Jackson Laboratory in Bar Harbour, Maine.
The 3×Tg-AD mice have three mutations, the Swedish (K670N/ M671L) mutation to amyloid precursor protein (APP), a mutation to presenilin-1 (PS1) (M146V), and a tau mutation (P301L) [@oddoTripleTransgenicModelAlzheimer2003]. 
Pups were weaned at 21 days of age and housed in same sex groups of 2-4 in transparent polyethylene cages (35 × 12 × 12 cm) with ad libitum food (Purina Rodent Chow #5001) and tap water. 
Housing cages contained pine chip bedding and a polyvinyl chloride tube (5 cm diameter, 8 cm long) for enrichment. 
The housing room was on a 12:12 h reversed light/dark cycle. Mice were genotyped using polymerase chain reaction by Dr. Chris Sinal (Department of Pharmacology, Dalhousie University). 
All test procedures were approved by the Dalhousie Committee on Animal Care (Protocol # 13-044).

Due to the small number of male mice, sexes are pooled together in this analysis.
There are `r dat %>% pull(animal) %>% unique() %>% length()` mice included in this study. 
The 3xTg-AD mice (`r format(age_table$age_mean[1], digits = 2)` ± `r format(age_table$age_sd[1], digits = 2)` days) were significantly younger than the B6129 mice (`r format(age_table$age_mean[2], digits = 2)` ± `r format(age_table$age_sd[2], digits = 2)` days; *t*~`r format(t_test_age$df, digits = 2)`~ = `r format(t_test_age$statistic, digits = 2)`, *p* `r format.p(t_test_age$p)`; @tbl-subjects).

## Apparatus

Two liquid dilution olfactometers (Knosys Olfactometers Inc.) previously described [@roddickOlfactoryDelayedMatching2014; @slotnickOlfactometryMice2005] were used. 
Air was sent through a filter after which it was split into two pathways, one as clean air, and the other flowed through a manifold which controlled the air flow through saturation bottles and into a T-junction, where clean and odorized air flows converged. 
The odour sampling port contained an infrared beam to detect nose-pokes, a reinforcement tube delivering the reward, and a sensor that detected when the mice were licking the reinforcement tube.

## Odours

```{r}
#| label: tbl-odours
#| tbl-cap: "Odorants used at each stage of testing."

odours_table <- read_csv(here("data", "odour_pairs.csv")) %>% 
    kbl(format = "latex",
        booktabs = TRUE,
        linesep = "")

odours_table

save_kable(odours_table,
           here("figures", "odours_table.pdf"))
```

All odorants were diluted in heavy mineral oil. See @tbl-odours for a list of odours used. 
For each mouse, the values of the odours, as either the rewarded (S+) odour or the unrewarded (S-) odour during each discrimination were randomly assigned.

## Water restriction

Ten days prior to the start of testing mice were individually housed and placed on water restriction. 
Mice were weighed daily and given measured amounts of mash (powdered food pellets mixed with water) to maintain their weight at approximately 85% of free feeding weight. 
They had *ad lib* access to food during water restriction.

## Behavioral testing

All behavioral testing was done during the dark phase of the light/dark cycle. 
The mice were initially trained for 20 trials to lick the reinforcement tube to receive a water reward and were rewarded for simply licking the reinforcement tube. 
The inter-trial interval increased from 0.1 s to 12 s over the 20 trials. 
During the next stage of training, a rewarded stimulus (S+) odour was introduced and the mice were required to keep their head in the odour sampling port while the final valve diverted the odour into the port. 
The amount of time the mice were required to keep their head in the port increased from 0.1 s to 1.1 s over 120 trials. 
This stage of training was completed when the mice performed 20 trials with the final valve on for 1.1 s. 

Mice were then introduced to the unrewarded (S-) odour. 
During this stage of training the mice were presented with a stimulus odour when they inserted their head into the odour sampling port, either a rewarded stimulus (S+), or an unrewarded stimulus (S-). 
When the mice were presented with the S+, they were rewarded for licking the reinforcement tube. 
Trials were initiated by the mice poking their nose into the odour sampling port, with a minimum inter-trial interval of 4 s. 
They were first presented with 20 trials of the S+ odour. 
If they did not respond to at least 85% of these S+ presentations they were placed back on the initial training. 
If they did respond to at least 85% of the S+ presentations, they were then presented with blocks of 20 trials consisting of 10 S+ trials and 10 S- trials. 
This continued until the mice achieved 85% correct responses on a block.

Mice were then moved to the testing stage. 
Mice were presented with a two odour discrimination problem using odour pair 1. 
They were given blocks of 20 trials, 10 S+ trials and 10 S- trials, until they achieved 85% correct. 
They were then presented with a reversal problem using odour pair 1. 
The values of the odours were reversed, such that the S+ became the S- and the S- became the S+. 
They were given blocks of 20 trials, 10 S+ trials and 10 S- trials, until they achieved 85% correct. 
This pattern of presenting the discrimination followed by the reversal was repeated with each odour pair.

## Statistical analysis

R version 4.2.2 [@rcoreteamLanguageEnvironmentStatistical2022]  was used for all analysis, using the “tidyverse” [@wickhamWelcomeTidyverse2019]  and “rstatix” [@kassambaraRstatixPipeFriendlyFramework2022] packages.


# Results

## Training

```{r}
#| label: fig-training-errors
#| fig-cap: "Errors made during training."

training_dat <- dat %>% 
    filter(op == 0)

training_ancova <- training_dat %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               covariate = days) %>% 
    get_anova_table()

training_summary <- training_dat %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(errors),
              errors_sd = sd(errors))

training_dat %>% 
    ggplot(aes(x = geno,
               y = errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               fill = NA) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Training errors",
         x = "Genotype")

ggsave(here("figures", "training_plot.pdf"),
       width = 6,
       height = 4)
```

An ANCOVA with age as a covariate was used to compare the number of errors made during training.
The B6129 mice (`r format(training_summary$errors_mean[2], digits = 2)` ± `r format(training_summary$errors_sd[2], digits = 2)`) made more errors than the 3xTg-AD mice (`r format(training_summary$errors_mean[2], digits = 2)` ± `r format(training_summary$errors_sd[2], digits = 2)`; *F*~(`r format(training_ancova$DFn[2], digits = 2)`,`r format(training_ancova$DFd[2], digits = 2)`)~ = `r format(training_ancova$F[2], digits = 2)`, *p* `r format.p(training_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(training_ancova$ges[2], digits = 2)`, @fig-training-errors).


## Difference scores

```{r}
#| label: fig-overall
#| fig-cap: "Errors (±95% CI) made by the mice at on each odour pair."

overall_dat <- dat %>% 
    filter(retest == FALSE,
           op_n > 0) %>% 
    pivot_wider(id_cols = c(animal, op, op_n, geno, days),
                names_from = rev,
                values_from = errors) %>% 
    select(animal,
           op,
           op_n,
           geno,
           days,
           disc = `FALSE`,
           rev = `TRUE`)
    
overall_dat %>% 
    pivot_longer(c(disc, rev),
                 names_to = "condition",
                 values_to = "errors") %>% 
    group_by(op_n, geno, condition) %>% 
    mutate(x = case_when(
        condition == "disc" ~ op_n,
        condition == "rev" ~ op_n + .33),
              y = errors) %>% 
    ggplot(aes(x = x,
               y = y,
               shape = condition,
               colour = geno)) +
    stat_summary(fun.data = "mean_cl_boot") +
    geom_segment(data = overall_dat %>%
                     group_by(op, geno) %>%
                     summarise(x = mean(op_n),
                               y = mean(disc, na.rm = TRUE),
                               xend = mean(op_n) + .33,
                               yend = mean(rev, na.rm = TRUE),
                               condition = "disc"),
                 aes(x = x, y = y, 
                     xend = xend, yend = yend), 
                     colour = "black") +
    facet_grid(rows = vars(geno)) +
    theme_bw() +
    scale_x_continuous(breaks = 1:18) +
    scale_shape_manual(values = c(16, 1),
                       labels = c("Discriminatinon trials", "Reversal trials")) +
    theme(panel.grid = element_blank(),
          legend.position = c(.8, .9),
          legend.title = element_blank(),
          legend.background = element_blank()) +
    guides(shape = "legend", colour = "none") +
    labs(x = "Odour pair",
         y = "Errors")

ggsave(here("figures", "difference_scores.pdf"),
       width = 6,
       height = 4)
```

```{r}
overall_diffs <- overall_dat %>% 
    mutate(diff_score = rev - disc,
           diff_pro = rev / disc)

overall_diffs_summary <- overall_diffs %>% 
    mutate(bin = case_when(
        op_n < 7 ~ 1,
        op_n >= 7 & op_n < 13 ~ 2,
        op_n >= 13 ~ 3
    )) %>% 
    group_by(bin, geno) %>% 
    summarise(across(starts_with("diff"),
                     .fns = list(mean = ~ mean(.x, na.rm = TRUE),
                                 sd = ~ sd(.x, na.rm = TRUE)),
                     .names = "{.col}_{.fn}"))

first_third_aov <- overall_diffs %>% 
    filter(op_n < 7,
           !is.na(diff_score)) %>% 
    ungroup() %>% 
    anova_test(dv = diff_score,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

first_third_ph <- overall_diffs %>% 
    filter(op_n < 7,
           !is.na(diff_score)) %>% 
    group_by(op) %>% 
    tukey_hsd(diff_score ~ geno)

second_third_aov <- overall_diffs %>% 
    filter(op_n >= 7,
           op_n < 13,
           !is.na(diff_score)) %>% 
    ungroup() %>% 
    anova_test(dv = diff_score,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

last_third_aov <- overall_diffs %>% 
    filter(op_n > 12,
           !is.na(diff_score)) %>% 
    ungroup() %>% 
    anova_test(dv = diff_score,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()
```

The sequence of odour pairs was divided into thirds, and ANCOVAs, with age as the covariate, examining the differences between the errors on the discrimination trials and the reversal trials were run on each third.
Greenhouse-Geisser corrections were applied when Mauchly's test for sphericity detected that within-subjects factors violated sphericity.

In the first third of odour pairs (1 - 6), there were significant effects of genotype (*F*~(`r format(first_third_aov$DFn[2], digits = 2)`,`r format(first_third_aov$DFd[2], digits = 2)`)~ = `r format(first_third_aov$F[2], digits = 2)`, *p* `r format.p(first_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(first_third_aov$ges[2], digits = 2)`), 
with the B6129 mice (`r format(overall_diffs_summary$diff_score_mean[2], diggits = 2)` ± `r format(overall_diffs_summary$diff_score_sd[2], diggits = 2)`) having greater differences scores than the 3xTg-AD mice (`r format(overall_diffs_summary$diff_score_mean[1], diggits = 2)` ± `r format(overall_diffs_summary$diff_score_sd[1], diggits = 2)`). 
There was no significant effect of odour pair (*F*~(`r format(first_third_aov$DFn[3], digits = 2)`,`r format(first_third_aov$DFd[3], digits = 2)`)~ = `r format(first_third_aov$F[3], digits = 2)`, *p* `r format.p(first_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(first_third_aov$ges[3], digits = 2)`; @fig-overall),
nor a significant interaction (*F*~(`r format(first_third_aov$DFn[5], digits = 2)`,`r format(first_third_aov$DFd[5], digits = 2)`)~ = `r format(first_third_aov$F[5], digits = 2)`, *p* `r format.p(first_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(first_third_aov$ges[5], digits = 2)`).

On the second third of odour pairs (7 - 12) there were no significant effects (*p*'s >= `r format(min(second_third_aov$p), digits = 2)`).

On the last third of odour pairs (13 - 18) there was a significant interaction between age and odour pair (*F*~(`r format(last_third_aov$DFn[4], digits = 2)`,`r format(last_third_aov$DFd[4], digits = 2)`)~ = `r format(last_third_aov$F[4], digits = 2)`, *p* `r format.p(last_third_aov$p[4], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[4], digits = 2)`), 
but no significant effects of genotype (*F*~(`r format(last_third_aov$DFn[2], digits = 2)`,`r format(last_third_aov$DFd[2], digits = 2)`)~ = `r format(last_third_aov$F[2], digits = 2)`, *p* `r format.p(last_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[2], digits = 2)`), 
odour pair (*F*~(`r format(last_third_aov$DFn[3], digits = 2)`,`r format(last_third_aov$DFd[3], digits = 2)`)~ = `r format(last_third_aov$F[3], digits = 2)`, *p* `r format.p(last_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[3], digits = 2)`), 
nor an interaction between genotype and odour pair (*F*~(`r format(last_third_aov$DFn[5], digits = 2)`,`r format(last_third_aov$DFd[5], digits = 2)`)~ = `r format(last_third_aov$F[5], digits = 2)`, *p* `r format.p(last_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(last_third_aov$ges[5], digits = 2)`).


## Discrimination

```{r}
#| label: fig-disc
#| fig-cap: "Errors (±95% CI) made by the mice at on each odour pair during the discrimination stages."

disc_dat <- dat %>% 
    filter(retest == FALSE, 
           rev == FALSE,
           op_n > 0)

disc_dat %>% 
    ggplot(aes(x = op_n,
               y = errors,
               colour = geno)) +
    # geom_point(alpha = .2,
    #            shape = 20) + 
    stat_summary(fun.data = "mean_cl_boot",
                 position = position_dodge(width = .33)) +
    # geom_smooth(se = FALSE) +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.9, .9)) +
    scale_x_continuous(breaks = 1:18) +
    labs(x = "Odour pair",
         y = "Errors")

ggsave(here("figures", "disc_plot.pdf"),
       width = 6,
       height = 4)
    
```

```{r}
disc_first_third_aov <- disc_dat %>% 
    filter(op_n < 7) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

disc_first_third_ph <- disc_dat %>% 
    filter(op_n < 7) %>% 
    ungroup() %>%
    tukey_hsd(errors ~ as.factor(op))

disc_second_third_aov <- disc_dat %>% 
    filter(op_n >= 7,
           op_n < 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

disc_last_third_aov <- disc_dat %>% 
    filter(op_n >= 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()
```

The sequence of odour pairs was divided into thirds, and ANCOVAs, with age as the covariate, examining the errors on the discrimination trials were run on each third (@fig-disc).
Greenhouse-Geisser corrections were applied when Mauchly's test for sphericity detected that within-subjects factors violated sphericity.

There were no significant effects in the first (1 - 6), second (7 - 12) or last thirds (13 - 18) of trials (*p*'s >= `r format(min(c(disc_first_third_aov$p, disc_second_third_aov$p, disc_last_third_aov$p), digits = 2))`).

### Near errorless learning

```{r}
#| label: fig-disc-errorless
#| fig-cap: "Number of mice showing errorless learning on each odour pair during discrimination."

disc_1_error <- disc_dat %>% 
    filter(errors == 1)

disc_0_error <- disc_dat %>% 
    filter(errors == 0)

disc_error <- disc_dat %>% 
    filter(errors <= 1)

disc_errorless_table <- disc_error %>% 
    pull(animal) %>% 
    table()

disc_best_mouse <- disc_errorless_table %>% 
    which.max() %>% 
    attr("names")

disc_best_geno <- geno$geno[geno$mouse == disc_best_mouse]

disc_errorless_dat <- disc_dat %>% 
    mutate(errorless = errors <= 1)

disc_errorless_dat %>% 
    filter(errorless) %>% 
    group_by(geno, op, op_n) %>% 
    count() %>%
    ungroup() %>% 
    complete(geno = levels(dat$geno),
             op_n = 1:18,
             fill = list(n = 0)) %>% 
    ggplot(aes(x = op_n,
               y = n,
               colour = geno)) +
    geom_point(position = position_dodge(width = .33)) +
    theme_classic() +
    scale_x_continuous(breaks  = 1:18) +
    scale_y_continuous(breaks = 0:7) +
    labs(x = "Odour pair",
         y = "Number of mice with 0 or 1 errors")  +
    theme(legend.title = element_blank(),
          legend.position = c(.1, .9))

ggsave(here("figures", "disc_errorless.pdf"),
       width = 6,
       height = 4)
```

```{r}
disc_errorless_chi_op <- tabyl(disc_errorless_dat, op_n, errorless) %>%
    chisq.test()

disc_errorless_chi_geno <- tabyl(disc_errorless_dat, geno, errorless) %>%
    chisq.test()
```

There were `r disc_1_error %>% nrow()` times where mice made a single error on the initial discrimination of the odour pair, and `r disc_0_error %>% nrow()` times where a mouse made zero errors (@fig-disc-errorless). 
With `r disc_errorless_table %>% length()` different mice passing at least one discrimination with just one or zero errors.
One mouse, a `r disc_best_geno`, had one or fewer errors on the initial discrimination of `r disc_errorless_table %>% max()` odour pairs.

Pearson's $\chi^2$ tests with Yate's continuity corrections were run on the number of mice showing errorless learning. 
The $\chi^2$ on the effect of odour pair was significant ($\chi^2$~`r format(disc_errorless_chi_op$parameter, digits = 2)`~ = `r format(disc_errorless_chi_op$statistic, digits = 2)`, *p* `r format.p(disc_errorless_chi_op$p.value)`),
with the majority of errorless discriminations occuring on odour pairs 8 - 18 as the number of errorless odour pairs increased from `r disc_error %>% filter(op_n < 7) %>% nrow()` to `r disc_error %>% filter(op_n >= 7, op_n < 13) %>% nrow()` to `r disc_error %>% filter(op_n >= 13) %>% nrow()` in each third of the odour pairs.
The $\chi^2$ on the effect of genotype was not significant ($\chi^2$~`r format(disc_errorless_chi_geno$parameter, digits = 2)`~ = `r format(disc_errorless_chi_geno$statistic, digits = 2)`, *p* `r format.p(disc_errorless_chi_geno$p.value)`).

### Age effects

```{r}
#| label: fig-disc-corr
#| fig-cap: "Correlation between age and errors made on odour pair one discrimination."

disc_corr_test <- disc_dat %>% 
    filter(op == 1) %>% 
    group_by(geno) %>% 
    cor_test(errors, days)

disc_dat %>% 
    filter(op == 1) %>% 
    ggplot(aes(x = days,
               y = errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank()) +
    labs(x = "Age (days)",
         y = "Errors")

ggsave(here("figures", "disc_age.pdf"),
       width = 6,
       height = 4)
```

Pearson's correlations were used to compare the number of errors made on odour pair one to the age of the mice for each genotype (@fig-disc-corr). 
The correlations were not significant for either the B6129 (*r* = `r format(disc_corr_test$cor[2], digits = 2)`, *p* `r format.p(disc_corr_test$p[2])`), 
nor the 3xTg-AD (*r* = `r format(disc_corr_test$cor[1], digits = 2)`, *p* `r format.p(disc_corr_test$p[1])`) mice, 
thus there was no significant change in errors with age.
{{< pagebreak >}}
## Reversal

```{r}
#| label: fig-rev
#| fig-cap: "Errors (±95% CI) made by the mice at on each odour pair during the reversal stages."

rev_dat <- dat %>% 
    filter(retest == FALSE, 
           rev == TRUE)

rev_dat %>% 
    ggplot(aes(x = op_n,
               y = errors,
               colour = geno)) +
    # geom_point(alpha = .2,
    #            shape = 20) + 
    stat_summary(fun.data = "mean_cl_boot",
                 position = position_dodge(width = .33)) +
    # geom_smooth(se = FALSE) +
    theme_classic() +
    theme(legend.title = element_blank(),
          legend.position = c(.9, .9)) +
    scale_x_continuous(breaks = 1:18) +
    labs(x = "Odour pair",
         y = "Errors")

ggsave(here("figures", "rev_plot.pdf"),
       width = 6,
       height = 4)
```

```{r}

rev_first_third_aov <- rev_dat %>% 
    filter(op_n < 7) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

rev_first_third_summary <- rev_dat %>% 
    filter(op_n < 7) %>% 
    group_by(geno) %>% 
    summarise(errors_mean = mean(errors, na.rm = TRUE),
              errors_sd = sd(errors, na.rm = TRUE))

rev_first_third_ph <- rev_dat %>% 
    filter(op_n < 7) %>% 
    group_by(op) %>%
    tukey_hsd(errors ~ geno)

rev_second_third_aov <- rev_dat %>% 
    filter(op_n >= 7,
           op_n < 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

rev_last_third_aov <- rev_dat %>% 
    filter(op_n >= 13) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               wid = animal,
               within = op,
               covariate = days) %>% 
    get_anova_table()

rev_last_third_ph <- rev_dat %>% 
    filter(op_n >= 13) %>% 
    group_by(op) %>%
    tukey_hsd(errors ~ geno)
```

The sequence of odour pairs was divided into thirds, and ANCOVAs, with age as the covariate, examining the errors on the reversal trials were run on each third (@fig-rev).
Greenhouse-Geisser corrections were applied when Mauchly's test for sphericity detected that within-subjects factors violated sphericity.

In the first third (1 - 6) of odour pairs there were significant effects of genotype (*F*~(`r format(rev_first_third_aov$DFn[2], digits = 2)`,`r format(rev_first_third_aov$DFd[2], digits = 2)`)~ = `r format(rev_first_third_aov$F[2], digits = 2)`, *p* `r format.p(rev_first_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(rev_first_third_aov$ges[2], digits = 2)`), 
with the B6129 mice (`r format(rev_first_third_summary$errors_mean[2], digits = 2)` ± `r format(rev_first_third_summary$errors_sd[2], digits = 2)`) making more errors than the 3xTg-AD mice (`r format(rev_first_third_summary$errors_mean[1], digits = 2)` ± `r format(rev_first_third_summary$errors_sd[1], digits = 2)`).
but no significant effect of odour pair (*F*~(`r format(rev_first_third_aov$DFn[3], digits = 2)`,`r format(rev_first_third_aov$DFd[3], digits = 2)`)~ = `r format(rev_first_third_aov$F[3], digits = 2)`, *p* `r format.p(rev_first_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(rev_first_third_aov$ges[3], digits = 2)`), 
nor an interaction (*F*~(`r format(rev_first_third_aov$DFn[5], digits = 2)`,`r format(rev_first_third_aov$DFd[5], digits = 2)`)~ = `r format(rev_first_third_aov$F[5], digits = 2)`, *p* `r format.p(rev_first_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(rev_first_third_aov$ges[5], digits = 2)`).

There were no significant effects in the second third (7 - 12) of odour pairs (*p*'s >= `r format(min(rev_last_third_aov$p), digits = 2)`).

In the last third (13 - 18) of odour pairs there was a significant interaction between age and odour pair (*F*~(`r format(rev_last_third_aov$DFn[4], digits = 2)`,`r format(rev_last_third_aov$DFd[4], digits = 2)`)~ = `r format(rev_last_third_aov$F[4], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[4], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[4], digits = 2)`), 
but no main effects of genotype (*F*~(`r format(rev_last_third_aov$DFn[2], digits = 2)`,`r format(rev_last_third_aov$DFd[2], digits = 2)`)~ = `r format(rev_last_third_aov$F[2], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[2], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[2], digits = 2)`),
odour pair (*F*~(`r format(rev_last_third_aov$DFn[3], digits = 2)`,`r format(rev_last_third_aov$DFd[3], digits = 2)`)~ = `r format(rev_last_third_aov$F[3], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[3], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[3], digits = 2)`),
nor an interaction between genotype and odour pair (*F*~(`r format(rev_last_third_aov$DFn[5], digits = 2)`,`r format(rev_last_third_aov$DFd[5], digits = 2)`)~ = `r format(rev_last_third_aov$F[5], digits = 2)`, *p* `r format.p(rev_last_third_aov$p[5], digits = 2)`, $\eta^2_G$ = `r format(rev_last_third_aov$ges[5], digits = 2)`).

### Near errorless learning

```{r}
#| label: fig-rev-errorless
#| fig-cap: "Number of mice showing errorless learning on each odour pair during reversal"

rev_1_error <- rev_dat %>% 
    filter(errors == 1)

rev_0_error <- rev_dat %>% 
    filter(errors == 0)

rev_error <- rev_dat %>% 
    filter(errors <= 1)

rev_errorless_table <- rev_error %>% 
    pull(animal) %>% 
    table()

rev_best_mouse <- rev_errorless_table %>% 
    which.max() %>% 
    attr("names")

rev_best_geno <- geno$geno[geno$mouse == rev_best_mouse]

rev_errorless_dat <- rev_dat %>% 
    mutate(errorless = errors <= 1)

rev_errorless_dat %>% 
    filter(errorless) %>% 
    group_by(geno, op_n) %>% 
    count() %>%
    ungroup() %>% 
    complete(geno = levels(dat$geno),
             op_n = 1:18,
             fill = list(n = 0)) %>% 
    ggplot(aes(x = op_n,
               y = n,
               colour = geno)) +
    geom_point(position = position_dodge(width = .33)) +
    theme_classic() +
    labs(x = "Odour pair",
         y = "Number of mice with 0 or 1 errors")  +
    scale_x_continuous(breaks = 1:18) +
    scale_y_continuous(breaks = 0:5) +
    theme(legend.title = element_blank(),
          legend.position = c(.1, .9))

ggsave(here("figures", "rev_errorless.pdf"),
       width = 6,
       height = 4)
```

```{r}
rev_errorless_chi_op <- tabyl(rev_errorless_dat, op_n, errorless) %>%
    chisq.test()

rev_errorless_chi_geno <- tabyl(rev_errorless_dat, geno, errorless) %>%
    chisq.test()
```

There were `r rev_1_error %>% nrow()` instances of mice making a single error on the reversal of the odour pair, and `r rev_0_error %>% nrow()` instances of a mouse making zero errors (@fig-rev-errorless). 
With `r rev_errorless_table %>% length()` mice passing at least one reversal with just one or zero errors.
One mouse, a `r rev_best_geno`, had one or fewer errors on the reversal of `r rev_errorless_table %>% max()` odour pairs.

Pearson's $\chi^2$ tests with Yate's continuity corrections were run on the number of mice showing errorsless learning. 
The $\chi^2$ on the effect of odour pair was significant ($\chi^2$~`r format(rev_errorless_chi_op$parameter, digits = 2)`~ = `r format(rev_errorless_chi_op$statistic, digits = 2)`, *p* `r format.p(rev_errorless_chi_op$p.value)`), 
with the majority of errorless discriminations occuring on odour pairs 8 - 18 as the number of errorless odour pairs increased from `r rev_error %>% filter(op_n < 7) %>% nrow()` to `r rev_error %>% filter(op_n >= 7, op_n < 13) %>% nrow()` to `r rev_error %>% filter(op_n >= 13) %>% nrow()` in each third of the odour pairs.
The $\chi^2$ on the effect of genotype was also significant ($\chi^2$~`r format(rev_errorless_chi_geno$parameter, digits = 2)`~ = `r format(rev_errorless_chi_geno$statistic, digits = 2)`, *p* `r format.p(rev_errorless_chi_geno$p.value)`), with the 3xTg-AD mice having more errorless reversals than the B6129 mice.

### Age effects

```{r}
#| label: fig-rev-corr
#| fig-cap: "Correlation between age and errors made on odour pair one reversal."

rev_corr_test <- rev_dat %>% 
    filter(op == 1) %>% 
    group_by(geno) %>% 
    cor_test(errors, days)

rev_dat %>% 
    filter(op == 1) %>%
    ggplot(aes(x = days,
               y = errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank()) +
    labs(x = "Age (days)",
         y = "Errors")

ggsave(here("figures", "rev_age.pdf"),
       width = 6,
       height = 4)
```

Pearson's correlations were used to compare the number of errors made on odour pair one to the age of the mice for each genotype. 
The correlations were not significant for either the B6129 (*r* = `r format(rev_corr_test$cor[2], digits = 2)`, *p* `r format.p(rev_corr_test$p[2])`), 
nor the 3xTg-AD (*r* = `r format(rev_corr_test$cor[1], digits = 2)`, *p* `r format.p(rev_corr_test$p[1])`) mice (@fig-rev-corr).
{{< pagebreak >}}
## Total errors

```{r}
#| label: tbl-total-errors-models
#| tbl-cap: "AICc model table for total errors."
#### Total errors ---------------------------------------------------

total_errors_dat <- dat %>% 
    filter(retest == FALSE,
           op_n > 0) %>% 
    group_by(animal, geno, days) %>% 
    summarise(total_errors = sum(errors))

total_errors_ancova <- total_errors_dat %>% 
    ungroup() %>% 
    anova_test(dv = total_errors,
               between = geno,
               covariate = days)
```

An ANCOVA, with age as the covariate, was used to assess the total errors made per mouse during the discrimination and reversal trials.
There was a significant effect of genotype (*F*~(`r format(total_errors_ancova$DFn[2], digits = 2)`,`r format(total_errors_ancova$DFd[2], digits = 2)`)~ = `r format(total_errors_ancova$F[2], digits = 2)`, *p* `r format.p(total_errors_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(total_errors_ancova$ges[2], digits = 2)`; @fig-total-errors).

```{r}
#| label: fig-total-errors
#| fig-cap: "Total errors made, excluding retest."

total_errors_dat %>% 
    ggplot(aes(x = geno,
               y = total_errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               fill = NA) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Total errors",
         x = "Genotype")

ggsave(here("figures", "total_errors_plot.pdf"),
       width = 6,
       height = 4)
```

### Age effects

```{r}
#| label: fig-total-errors-corr
#| fig-cap: "Correlation between age and total errors made."

total_errors_corr_test <- total_errors_dat %>% 
    group_by(geno) %>% 
    cor_test(total_errors, days)

total_errors_dat %>% 
    ggplot(aes(x = days,
               y = total_errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank()) +
    labs(x = "Age (days)",
         y = "Total errors")

ggsave(here("figures", "total_errors_age.pdf"),
       width = 6,
       height = 4)
```

Pearson correlations were used to compare the total number of errors made per mouse to the age of the mice for each genotype (@fig-total-errors-corr). 
The correlations were not significant for either the B6129 (*r* = `r format(total_errors_corr_test$cor[2], digits = 2)`, *p* `r format.p(total_errors_corr_test$p[2])`), 
nor the 3xTg-AD (*r* = `r format(total_errors_corr_test$cor[1], digits = 2)`, *p* `r format.p(total_errors_corr_test$p[1])`) mice.
{{< pagebreak >}}
## Retest

```{r}
retest_dat <- dat %>% 
    filter(retest == TRUE)

retest_date_t_test <- geno %>% 
    filter(mouse %in% retest_dat$animal) %>%
    t_test(retest_days ~ geno)

retest_summary <- geno %>% 
    filter(mouse %in% retest_dat$animal) %>%
    group_by(geno) %>% 
    summarise(days_mean = mean(retest_days, na.rm = TRUE),
            days_sd = sd(retest_days, na.rm = TRUE))

retest_table <- retest_dat %>% 
    group_by(geno) %>% 
    count()
```

Because some mice died, only `r retest_table$n[2]` `r retest_table$geno[2]` and `r retest_table$n[1]` `r retest_table$geno[1]` mice were given the retest.
Because 3xTg-AD mice have a shorter lifespan than B6129 mice [@raeProblemGenotypeSex2015],
fewer 3xTg-AD mice (`r retest_table$n[1]` / `r subj_n_table$n[1]`) survived to be given the retest than the B6129 mice (`r retest_table$n[2]` / `r subj_n_table$n[2]`).

The retest occurred between `r format(min(retest_dat$retest_days), digits = 2)` and `r format(max(retest_dat$retest_days), digits = 2)` days after the final reversal. There was no difference between the days until the retest for the B6129 (`r format(retest_summary$days_mean[2], digits = 2)` ± `r format(retest_summary$days_sd[2], digits = 2)`) and 3xTg-AD (`r format(retest_summary$days_mean[1], digits = 2)` ± `r format(retest_summary$days_sd[1], digits = 2)`; *t*~`r format(retest_date_t_test$df, digits = 2)`~ = `r format(retest_date_t_test$statistic, digits = 2)`, *p* `r format.p(retest_date_t_test$p)`).

```{r}
retest_ancova <- retest_dat %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between = geno,
               covariate = days)
```

An ANCOVA, with age as the covariate, was used to assess the number of errors made during the retest. 
There was no significant effect of genotype (*F*~(`r format(retest_ancova$DFn[2], digits = 2)`,`r format(retest_ancova$DFd[2], digits = 2)`)~ = `r format(retest_ancova$F[2], digits = 2)`, *p* `r format.p(retest_ancova$p[2], digits = 2)`, $\eta^2_G$ = `r format(retest_ancova$ges[2], digits = 2)`; @fig-retest-errors)

```{r}
retest_vs_18_t_test <- retest_dat %>% 
    left_join(disc_dat %>% 
                  filter(op == 18) %>% 
                  select(animal, 
                         errors_18 = errors)) %>% 
    pivot_longer(cols = c(errors, errors_18),
                 names_to = "test",
                 values_to = "errors") %>% 
    # group_by(geno) %>% 
    t_test(errors ~ test,
           paired = TRUE)

retest_vs_18_summary <- retest_dat %>% 
    left_join(disc_dat %>% 
                  filter(op == 18) %>% 
                  select(animal, 
                         errors_18 = errors)) %>% 
    pivot_longer(cols = c(errors, errors_18),
                 names_to = "test",
                 values_to = "errors") %>%
    group_by(test) %>% 
    summarise(errors_mean = mean(errors),
              errors_sd = sd(errors))
```

A paired t-test was used to compare the number of errors made during the retest to the numbers of errors made on the final odour discrimination. 
The mean number of errors made during the retest (`r format(retest_vs_18_summary$errors_mean[1], digits = 2)` ± `r format(retest_vs_18_summary$errors_sd[1], digits = 2)`) was significantly higher than the errors made on the final odour discrimination (`r format(retest_vs_18_summary$errors_mean[2], digits = 2)` ± `r format(retest_vs_18_summary$errors_sd[2], digits = 2)`; *t*~`r format(retest_vs_18_t_test$df, digits = 2)`~ = `r format(retest_vs_18_t_test$statistic, digits = 2)`, *p* `r format.p(retest_vs_18_t_test$p)`).

```{r}
#| label: fig-retest-errors
#| fig-cap: "Total errors made during retest."

retest_dat %>% 
    ggplot(aes(x = geno,
               y = errors,
               fill = geno)) +
    geom_boxplot(outlier.shape = NA) +
    geom_dotplot(binaxis = "y", 
               stackdir = "center",
               fill = NA) +
    theme_classic() +
    theme(legend.position = "none") +
    labs(y = "Errors",
         x = "Genotype")

ggsave(here("figures", "retest_plot.pdf"),
       width = 6,
       height = 4)
```

### Age effects

```{r}
#| label: fig-retest-corr
#| fig-cap: "Correlation between age and errors made on the retest."

retest_corr_test <- retest_dat %>% 
    group_by(geno) %>% 
    cor_test(errors, days)

retest_dat %>% 
    ggplot(aes(x = days,
               y = errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank()) +
    labs(x = "Age (days)",
         y = "Total errors")

ggsave(here("figures", "retest_age.pdf"),
       width = 6,
       height = 4)
```

Pearson correlations were used to compare the number of errors made on the retest to the age of the mice for each genotype (@fig-retest-corr). 
The correlations was not significant for the B6129 (*r* = `r format(retest_corr_test$cor[2], digits = 2)`, *p* `r format.p(retest_corr_test$p[2])`), 
but was for the 3xTg-AD (*r* = `r format(retest_corr_test$cor[1], digits = 2)`, *p* `r format.p(retest_corr_test$p[1])`) mice.

### Time from last test effect

```{r}
#| label: fig-retest-delay-corr
#| fig-cap: "Correlation between days after last reversal and errors made on the retest."

retest_days_corr_test <- retest_dat %>% 
    group_by(geno) %>%
    cor_test(errors, retest_days)

retest_delay_aov <- retest_dat %>% 
    mutate(delay = case_when(
        retest_days < 45 ~ 1,
        retest_days > 45 & retest_days < 75 ~ 2,
        retest_days > 75 ~ 3
    ) %>% 
        as.factor()) %>% 
    ungroup() %>% 
    anova_test(dv = errors,
               between =  c(geno, delay),
               covariate = days)

retest_dat %>% 
    ggplot(aes(x = retest_days,
               y = errors,
               colour = geno)) +
    geom_point() +
    geom_smooth(method = "lm") + 
    theme_classic() +
    theme(legend.title = element_blank()) +
    scale_x_continuous(breaks = c(30, 60, 90)) +
    scale_y_continuous(breaks = seq(0, 120, by = 20)) +
    labs(x = "Days since last reversal",
         y = "Total errors")

ggsave(here("figures", "retest_delay.pdf"),
       width = 6,
       height = 4)
```

Pearson correlations were used to compare the number of errors made on the retest to the days since the final reversal. 
There was a significant, positive correlation for the B6129 mice (*r* = `r format(retest_days_corr_test$cor[2], digits = 2)`, *p* `r format.p(retest_days_corr_test$p[2])`), 
but not for the 3xTg-AD mice (*r* = `r format(retest_days_corr_test$cor[1], digits = 2)`, *p* `r format.p(retest_days_corr_test$p[1])`; @fig-retest-delay-corr).

An ANCOVA, with age as a covariate, was run examining the effects of genotype and time since last reversal on the errors made on the retest. 
The time since last reversal was binned into 30, 60, and 90 day groups.
There were no significant effects (*p*'s >= `r format(min(retest_delay_aov$p), digits = 2)`).

# References
